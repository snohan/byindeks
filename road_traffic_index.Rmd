---
#title: Vegtrafikkindeksen
output: 
  officedown::rdocx_document:
    reference_docx: svv_template.docx
    toc: true
    toc_depth: 2
    fig_caption: true
    fig_width: 7
    tables:
      style: Table
      layout: autofit
      width: 1.0
      caption:
        style: Tabelltekst
        pre: 'Tabell'
        sep: '. '
      conditional:
        first_row: true
        first_column: false
        last_row: false
        last_column: false
        no_hband: false
        no_vband: true
    plots:
      style: Normal
      align: center
      caption:
        style: Figurtekst
        pre: 'Figur '
        sep: '. '
    lists:
      ol.style: null
      ul.style: null
---

```{r setup, include = FALSE, echo = FALSE, warning=FALSE, message=FALSE}
# Packages are loaded through sourcing rmd_setup.R
source("rmd_setup.R")

# Traffic Data API calls to get points metadata and aadt
source("get_from_trafficdata_api.R")
```

```{r get_data, include=FALSE}
this_year <- 2020
latest_month_number <- 12

# Fetching published index from Traffic Data API
index_2020 <- get_published_road_traffic_index_for_months(962, this_year, latest_month_number)

# TODO: Include urban and non-urban index
#index_2020_urban <- get_published_index_for_months(1952, 2020, 7)
#index_2020_non_urban <- get_published_index_for_months(955, 2020, 7)

# index_2020 <- dplyr::bind_rows(index_2020_all,
#                                index_2020_urban,
#                                index_2020_non_urban)
```

```{r prepare_data}
index_2020_prepared <- index_2020 %>% 
  dplyr::mutate(length_range = dplyr::case_when(length_range == "[..,..)" ~ "alle",
                                                length_range == "[..,5.6)" ~ "lette",
                                                length_range == "[5.6,..)" ~ "tunge"),
                day_type = dplyr::case_when(day_type == "ALL" ~ "alle",
                                            day_type == "WEEKDAY" ~ "yrkedøgn",
                                            day_type == "WEEKEND" ~ "helgedøgn")) %>% 
  dplyr::mutate(road_category = dplyr::case_when(
                  road_category == "FYLKESVEG" ~ "Fylkesveg",
                  road_category == "EUROPAVEG_RIKSVEG" ~ "Europa- og riksveg",
                  road_category == "EUROPAVEG_RIKSVEG_FYLKESVEG" ~ "Europa-, riks- og fylkesveg")) %>% 
  dplyr::mutate(standard_deviation = round(standard_deviation, digits = 1),
                month_object = lubridate::make_date(year = year, month = month),
                month_name = lubridate::month(month_object, label = TRUE, abbr = FALSE))

latest_month_name <- max(index_2020_prepared$month_name) %>% as.character()

index_this_month <- index_2020_prepared %>% 
  dplyr::filter(area_type == "COUNTRY",
                period == "month",
                length_range == "alle",
                road_category == "Europa-, riks- og fylkesveg",
                day_type == "alle",
                month == latest_month_number)

less_or_more_month <- dplyr::if_else(index_this_month$index_p < 0, "mindre", "mer")

index_so_far_this_year_all <- index_2020_prepared %>% 
  dplyr::filter(area_type == "COUNTRY",
                period == "year_to_date",
                length_range == "alle",
                road_category == "Europa-, riks- og fylkesveg",
                day_type == "alle",
                month == latest_month_number) %>% 
  dplyr::select(index_p) %>% 
  round(digits = 1)

less_or_more_so_far <- dplyr::if_else(index_so_far_this_year_all$index_p < 0, "mindre", "mer")

index_so_far_this_year_all_character <- index_so_far_this_year_all %>% 
  abs() %>% 
  as.character() %>% 
  decimal_comma()

index_so_far_this_year_light <- index_2020_prepared %>% 
  dplyr::filter(area_type == "COUNTRY",
                period == "year_to_date",
                length_range == "lette",
                road_category == "Europa-, riks- og fylkesveg",
                day_type == "alle",
                month == latest_month_number) %>% 
  dplyr::select(index_p) %>% 
  round(digits = 1) %>% 
  as.character() %>% 
  decimal_comma()

index_so_far_this_year_heavy <- index_2020_prepared %>% 
  dplyr::filter(area_type == "COUNTRY",
                period == "year_to_date",
                length_range == "tunge",
                road_category == "Europa-, riks- og fylkesveg",
                day_type == "alle",
                month == latest_month_number ) %>% 
  dplyr::select(index_p) %>% 
  round(digits = 1) %>% 
  as.character() %>% 
  decimal_comma()

index_so_far_this_year_r <- index_2020_prepared %>% 
  dplyr::filter(area_type == "COUNTRY",
                period == "year_to_date",
                length_range == "alle",
                road_category == "Europa- og riksveg",
                day_type == "alle",
                month == latest_month_number ) %>% 
  dplyr::select(index_p) %>% 
  round(digits = 1) %>% 
  as.character() %>% 
  decimal_comma()

index_so_far_this_year_f <- index_2020_prepared %>% 
  dplyr::filter(area_type == "COUNTRY",
                period == "year_to_date",
                length_range == "alle",
                road_category == "Fylkesveg",
                day_type == "alle",
                month == latest_month_number ) %>% 
  dplyr::select(index_p) %>% 
  round(digits = 1) %>% 
  as.character() %>% 
  decimal_comma()
```

<br>

**Tabelliste**
```{r list_of_tables}
officer::block_toc(style = "Tabelltekst")
```

<br>

**Figurliste**
```{r list_of_figures}
officer::block_toc(style = "Figurtekst")
```

# Vegtrafikkindeksen

Vegtrafikkindeksen er i `r this_year` rekna ut frå om lag 1 200 utvalde trafikkregistreringspunkt som er eigd av Statens vegvesen og fylkeskommunane. Trafikken vert registrert kontinuerleg kvar time heile året, og for kvart trafikkregistreringspunkt vert trafikken samanlikna time for time, dato mot dato i kalendermånadene. Utvalet gir truleg eit godt bilete av utviklinga i trafikkarbeidet. Tala er gitt som endring i prosent i forhold til same tidsperiode året før. 

Ver merksam på at ulike forhold kan gi store utslag i tala per månad frå år til år. Slike hendingar kan vera helgedagar utan fast dato, til dømes påske og pinse. Veret er også ein faktor som kan gi utslag på månadstala. Koronapandemien påverkar sterkt utviklinga i trafikken i 2020. 
Alle data er henta frå [www.vegvesen.no/trafikkdata/](https://www.vegvesen.no/trafikkdata/). Timetrafikk med minst 99 % dekningsgrad inngår i berekningsgrunnlaget.

Nokre trafikkregistreringspunkt er periodevis utelatne på grunn av feil på utstyr eller at dei ligg på vegar som er påverka av vegarbeid o.l.


## Definisjonar
**Helgedøgn**: Laurdag og søndag kl. 00:00-23:59, alle offentlege fridagar og jule- og nyårskvelden. 
<br>
**Yrkedøgn**: Alle døgn minus helgedøgn.

**Lette køyretøy**: Lengde < 5,6 meter 
<br>
**Tunge køyretøy**: Lengde ≥ 5,6 meter


# Trafikkutviklinga i Noreg

Kort oppsummert har trafikkutviklinga vore som følgjer: 
<br>
Det var `r index_so_far_this_year_all_character` % *`r less_or_more_so_far`* trafikk i `r this_year` enn i `r this_year - 1`. 

Utviklinga for lette og tunge køyretøy i `r this_year` er berekna til `r index_so_far_this_year_light` % og `r index_so_far_this_year_heavy` %.

Trafikkauken for ulike vegkategoriar: 
<br>
Riksvegar i alt (Ev + Rv): `r index_so_far_this_year_r` %. 
<br>
Fylkesvegar: `r index_so_far_this_year_f` %.


## Trafikkutviklinga for heile året

I tabellen nedanfor visast trafikkutviklinga for heile Noreg. Den statistiske spreiinga i datagrunnlaget er gitt av standardavviket.

<br>

```{r so_far_this_year_table_road_category}
index_2020_prepared %>%
  dplyr::filter(period == "year_to_date",
                month == latest_month_number,
                day_type == "alle",
                area_type == "COUNTRY") %>%
  dplyr::arrange(road_category, length_range) %>%
  dplyr::mutate(area_name_here = "Noreg") %>% 
  dplyr::select(area_name_here, road_category, length_range, index_p, standard_deviation) %>%
  flextable::flextable() %>%
  colformat_double(j = 4:5, digits = 1) %>%
  set_header_labels(area_name_here = "Område", 
                    road_category = "Vegkategori", length_range = "Køyretøy-klasse",
                    index_p = "Endring i trafikkmengde (%)",
                    standard_deviation = "Standardavvik") %>%
  align(j = 4:5, align = "center", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Lucida Sans Unicode", part = "all") %>%
  bg(bg = "#ED9300", part = "header") %>%
  border_remove() %>%
  hline_top(part = "header", border = borderline) %>%
  hline_bottom(part = "all", border = borderline) %>%
  hline(i = c(3, 6), part = "body",
        border = fp_border(color = "#dadada", width = 1)) %>% 
  height_all(height = .2) %>%
  width(j = 2, width = 2.1) %>%
  fix_border_issues() %>%
  padding(padding.top = .3,
          padding.bottom = .3) %>%
  set_caption("Estimert samla endring i trafikkmengde frå 2019 til 2020 per vegkategori.",
               autonum = table_numbers,
               style = "Tabelltekst")
```

<br>


```{r so_far_this_year_table_day_type}
index_2020_prepared %>%
  dplyr::filter(period == "year_to_date",
                month == latest_month_number,
                road_category == "Europa-, riks- og fylkesveg",
                area_type == "COUNTRY") %>%
  dplyr::arrange(day_type, length_range) %>%
  dplyr::mutate(area_name_here = "Noreg") %>% 
  dplyr::select(area_name_here, day_type, length_range, index_p, standard_deviation) %>%
  flextable::flextable() %>%
  colformat_double(j = 4:5, digits = 1) %>%
  set_header_labels(area_name_here = "Område", 
                    day_type = "Døgntype", length_range = "Køyretøy-klasse",
                    index_p = "Endring i trafikkmengde (%)",
                    standard_deviation = "Standardavvik") %>%
  align(j = 4:5, align = "center", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Lucida Sans Unicode", part = "all") %>%
  bg(bg = "#ED9300", part = "header") %>%
  border_remove() %>%
  hline_top(part = "header", border = borderline) %>%
  hline_bottom(part = "all", border = borderline) %>%
  hline(i = c(3, 6), part = "body",
        border = fp_border(color = "#dadada", width = 1)) %>% 
  height_all(height = .2) %>%
  width(j = 2, width = 2.1) %>%
  fix_border_issues() %>%
  padding(padding.top = .3,
          padding.bottom = .3) %>%
  set_caption("Estimert samla endring i trafikkmengde frå 2019 til 2020 per døgntype.",
               autonum = table_numbers,
               style = "Tabelltekst")
```

<br>

## Trafikkutviklinga for kvar månad

Utviklinga per månad gjennom året, visast i figur 1 på neste side.

```{r road_category_plot, fig.width=6.5, fig.height=7, fig.cap="Månadleg trafikkutvikling i Noreg per vegkategori."}
index_2020_prepared %>%
  dplyr::filter(period == "month",
                day_type == "alle",
                area_type == "COUNTRY") %>%
  ggplot2::ggplot(aes(x = month_object, y = index_p, color = length_range)) +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::facet_grid(rows = vars(road_category)) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90),
        panel.grid.minor.x = element_blank()) +
  scale_x_date(breaks = scales::breaks_width("months"),
               labels = scales::label_date("%b")) +
  scale_color_manual(values = c("alle" = "#008ec2",
                                "lette" = "#ed9300",
                                "tunge" = "#444f55"),
                     name = "Kjøretøyklasse") +
  labs(x = NULL, y = "Endring i trafikkmengde (%) \n",
       caption = "Data: Statens vegvesen og fylkeskommunane") +
  ggtitle("Estimert endring i trafikkmengde",
          subtitle = "Trafikkmengde i 2020 sammenlignet med 2019") +
  theme(legend.position = "bottom")
```

## Trafikkutviklinga i yrke- og helgedøgn

```{r day_type_plot_monthly, fig.width=6.5, fig.height=7, fig.cap="Månadleg trafikkutvikling i Noreg per døgntype."}
index_2020_prepared %>%
  dplyr::filter(period == "month",
                road_category == "Europa-, riks- og fylkesveg",
                area_type == "COUNTRY") %>%
  ggplot2::ggplot(aes(x = month_object, y = index_p, color = length_range)) +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::facet_grid(rows = vars(day_type)) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90),
        panel.grid.minor.x = element_blank()) +
  scale_x_date(breaks = scales::breaks_width("months"),
               labels = scales::label_date("%b")) +
  scale_color_manual(values = c("alle" = "#008ec2",
                                "lette" = "#ed9300",
                                "tunge" = "#444f55"),
                     name = "Kjøretøyklasse") +
  labs(x = NULL, y = "Endring i trafikkmengde (%) \n",
       caption = "Data: Statens vegvesen og fylkeskommunane") +
  ggtitle("Estimert endring i trafikkmengde",
          subtitle = "Trafikkmengde i 2020 sammenlignet med 2019") +
  theme(legend.position = "bottom")
```

```{r day_type_table_so_far}

```




# Trafikkutviklinga i landsdelane

## Trafikkutviklinga for heile året

## Trafikkutviklinga for kvar månad


```{r year_to_date_plot}
# TODO: lollipop plot comparing each county, faceted by lenght_range
```




# Trafikkutviklinga i fylka

## Trafikkutviklinga for heile året

## Trafikkutviklinga for kvar månad

<!--
## Historisk utvikling
# TODO: distance matrix
-->

