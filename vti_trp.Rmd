---
title: "Vegtrafikkindekspunkter"
output: html_notebook
---

Trafikkregistreringspunkter som skal benyttes i Vegtrafikkindeksen.

```{r setup, message=FALSE, warning=FALSE, results='hide'}
source("H:/Programmering/R/byindeks/rmd_setup.R")
source("H:/Programmering/R/byindeks/get_from_trp_api.R")
source("H:/Programmering/R/byindeks/get_from_trafficdata_api.R")

library(DT)
library(htmltools)
```

```{r get_trp, results='hide'}
trp_for_vti <- get_trp_for_vti()

trp_aadts_1_25 <- trp_for_vti$trp_id[1:250] %>% 
  get_aadt_for_trp_list() %>% 
  dplyr::filter(year == 2018)

trp_aadts_250_500 <- trp_for_vti$trp_id[251:500] %>% 
  get_aadt_for_trp_list() %>% 
  dplyr::filter(year == 2018)

trp_aadts_501_n <- trp_for_vti$trp_id[501:1994] %>% 
  get_aadt_for_trp_list() %>% 
  dplyr::filter(year == 2018)

trp_aadts <- bind_rows(
  trp_aadts_1_25,
  trp_aadts_250_500,
  trp_aadts_501_n
)

# TODO: change to 2019 in get_from_td_api
trp_for_vti_aadt <- trp_for_vti %>% 
  dplyr::left_join(trp_aadts) %>% 
  dplyr::filter(!is.na(adt),
                coverage > 90) %>% 
  dplyr::mutate(valid_length_ratio = valid_length_volume / adt) %>%
  dplyr::mutate(trp_label = paste(name, road_reference, sep = "<br/>"),
                trp_label = lapply(trp_label, htmltools::HTML))

# TODO: pointindex 2019
```

```{r table}
# DataTables
trp_for_vti_aadt %>% 
  dplyr::select(county_number, legacyNortrafMpn, name,
                road_category, road_number, parsell, meter, adt) %>%
  dplyr::mutate(county_number = as.character(county_number),
                legacyNortrafMpn = as.character(legacyNortrafMpn),
                road_number = as.character(road_number),
                parsell = as.character(parsell)) %>% 
  dplyr::rename(Fylke = county_number,
                Nortrafnr = legacyNortrafMpn,
                Navn = name,
                Vegkat = road_category,
                Vegnr = road_number,
                Parsell = parsell,
                Meter = meter,
                AADT = adt) %>% 
  DT::datatable(
    filter = "top",
    extensions = "Buttons",
    options = list(
      dom = "Blfrtip",
      buttons = c("excel"),
      pageLength = 25,
      lengthMenu = c(25, 50, 100),
      autoWidth = TRUE))
```

```{r map}
palett_adt <-
 colorNumeric(palette = "Greens",
              domain = NULL)

# TODO: county polygons (nice to have)
# TODO: add road categories as layers (one addCircleMarkers per layer?)
trp_for_vti_aadt %>% 
  leaflet(width = "100%",
          options = leafletOptions(crs = nvdb_crs,
                                   zoomControl = TRUE)) %>%
  addTiles(urlTemplate = nvdb_map_url,
           attribution = nvdb_map_attribution) %>%
  addCircleMarkers(
    radius = 6,
    stroke = T,
    weight = 2,
    color = "#444f55",
    opacity = 0.8,
    fill = T,
    fillColor = ~palett_adt(adt),
    fillOpacity = 0.8,
    label = ~trp_label
  ) %>%
  addLegend("bottomright",
            pal = palett_adt,
            values = ~adt,
            title = "Ã…DT",
            opacity = 0.7,
            labFormat = labelFormat(big.mark = " "))
```


