---
title: Daglig endring i trafikk i de største byområdene
output: 
  word_document:
    reference_docx: svv_notatmal3.docx
    toc: true
    toc_depth: 2
    fig_caption: true
    fig_width: 7
---

```{r setup, include = FALSE, echo = FALSE, warning=FALSE, message=FALSE}
# Packages are loaded through sourcing rmd_setup.R
source("rmd_setup.R")

# Traffic Data API calls to get points metadata and aadt
source("get_from_trafficdata_api.R")

# Points used in each city
cities_points_start <- read.csv2("data_points_raw/cities_points.csv") %>% 
  dplyr::filter(city_area_name %in% c("Bergen",
                                      "Nord-Jæren",
                                      "Oslo og Akershus",
                                      "Trondheim",
                                      "Tromsø"),
                !is.na(trp_id)) %>% 
  dplyr::distinct(trp_id, .keep_all = TRUE) %>% 
  dplyr::select(city_area_name, trp_id) %>% 
  # Remove unusable trps
  dplyr::filter(!(trp_id %in% c("65625V41945",
                                "21801V72158",
                                "81008V41567",
                                "14772V41375",
                                "20570V72811",
                                "17949V320695",
                                "75341V41863")))

additional_trps <- 
  data.frame(city_area_name = 
               c(rep("Trondheim", times = 9),
                 rep("Nord-Jæren", times = 29),
                 rep("Bodø", times = 11)),
             trp_id = c(
                                  # Trondheim
                                  "04211V1677432",
                                  "78492V2394249",
                                  "44660V72811",
                                  "75341V41863",
                                  "17961V72812",
                                  "36935V72359",
                                  "01676V41944",
                                  "60797V2801059",
                                  "66126V3112188",
                                  # Nord-Jæren
                                  #"93189V320582",
                                  "52780V320689",
                                  "13715V2721330",
                                  "14570V320273",
                                  #"50749V319525",
                                  "11531V320190",
                                  #"71535V319524",
                                  "50741V1727509",
                                  "41451V320581",
                                  "64211V2520554",
                                  "55507V319881",
                                  "33926V2721315",
                                  "12478V320582",
                                  "88125V320152",
                                  "33902V320184",
                                  "84064V320581",
                                  "08952V320223",
                                  "81631V1727485",
                                  "59675V319722",
                                  "58562V320296",
                                  "03819V320689",
                                  "45342V320223",
                                  "44083V319868",
                                  "35382V1727514",
                                  "24330V320678",
                                  "36178V320198",
                                  #"92102V319885",
                                  #"32842V319521",
                                  "61487V319872",
                                  "00462V320124",
                                  "48362V320684",
                                  "89794V320138",
                                  "05658V320707",
                                  "57836V319878",
                                  # Bodø
                                  "18346V886007",
                                  "43264V886007",
                                  "66316V2676855",
                                  "33696V2676853",
                                  "91229V886007",
                                  "26549V2669516",
                                  "29133V1201961",
                                  "90646V1201961",
                                  "74801V2676825",
                                  "77027V1207593",
                                  "86957V885288"
                                  ))

cities_points <- bind_rows(cities_points_start, additional_trps)

# All points from Traffic Data API
points <- get_points() %>%
  dplyr::select(trp_id, name, road_reference, municipality_name,
                lat, lon) %>%
  dplyr::distinct(trp_id, .keep_all = T)

# Adding metadata to trps
trps <- dplyr::left_join(cities_points, points) %>%
  dplyr::filter(!is.na(name)) %>% 
  dplyr::filter(!stringr::str_detect(road_reference, "KD"))

# Fetch daily traffic
week_2019_from <- "2019-07-01T00:00:00+02:00"
week_2019_to <- "2019-09-30T00:00:00+02:00"

week_2020_from <- "2020-06-29T00:00:00+02:00"
week_2020_to <- "2020-09-28T00:00:00+02:00"

ukedager <- c("Mandag",
              "Tirsdag",
              "Onsdag",
              "Torsdag",
              "Fredag",
              "Lørdag",
              "Søndag")

norske_ukedager <- data.frame(weekday = c(1, 2, 3, 4, 5, 6, 7),
                              ukedag = ordered(ukedager,
                                               levels = ukedager))

# Fetch daily traffic from API
dt_2019 <- get_dt_for_trp_list(trps$trp_id,
                               week_2019_from,
                               week_2019_to)

dt_2020 <- get_dt_for_trp_list(trps$trp_id,
                               week_2020_from,
                               week_2020_to)

dt <- bind_rows(dt_2019, dt_2020) %>%
  select(-point_name) %>%
  mutate(year = lubridate::year(from),
         weekno = lubridate::isoweek(from),
         weekday = lubridate::wday(from,
                                   week_start = 
                                     getOption("lubridate.week.start", 1))) %>%
  select(-from) %>% 
  filter(coverage > 99)


# Weeks 2019 ####
dt_2019_27 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 27) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "33808V625649",
                           "84064V320581",
                           "75341V41863",
                           "04300V72813",
                           "86173V805748")))

dt_2019_28 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 28) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "33808V625649",
                           "84064V320581",
                           "86173V805748",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "75341V41863")))

dt_2019_29 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 29) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "33808V625649",
                           "84064V320581",
                           "86173V805748",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "75341V41863")))

dt_2019_30 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 30) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "84064V320581",
                           "86173V805748",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "33808V625649",
                           "75341V41863",
                           "17961V72812")))

dt_2019_31 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 31) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "84064V320581",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "33808V625649",
                           "75341V41863",
                           "17961V72812")))

dt_2019_32 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 32) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "84064V320581",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "33808V625649",
                           "75341V41863",
                           "17961V72812")))

dt_2019_33 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 33) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "84064V320581",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "33808V625649",
                           "75341V41863",
                           "17961V72812")))

dt_2019_34 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 34) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "84064V320581",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "33808V625649",
                           "75341V41863",
                           "17961V72812")))

dt_2019_35 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 35) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "84064V320581",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "33808V625649",
                           "75341V41863",
                           "17961V72812")))

dt_2019_36 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 36) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "84064V320581",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "33808V625649",
                           "75341V41863",
                           "17961V72812")))

dt_2019_37 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 37) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "84064V320581",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "33808V625649",
                           "75341V41863",
                           "17961V72812")))

dt_2019_38 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 38) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "84064V320581",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "33808V625649",
                           "75341V41863",
                           "17961V72812")))

dt_2019_39 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 39) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378",
                           "91229V886007",
                           "42754V444240",
                           "84064V320581",
                           "36178V320198",
                           "57836V319878",
                           "18573V444291",
                           "04300V72813",
                           "33808V625649",
                           "75341V41863",
                           "17961V72812")))


# ADD NEW WEEK HERE!


# Weeks 2020 ####
dt_2020_27 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 27) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244")))

dt_2020_28 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 28) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244")))

dt_2020_29 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 29) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244")))

dt_2020_30 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 30) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244")))

dt_2020_31 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 31) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244")))

dt_2020_32 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 32) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244")))

dt_2020_33 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 33) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244")))

dt_2020_34 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 34) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244")))

dt_2020_35 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 35) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244")))

dt_2020_36 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 36) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244")))

dt_2020_37 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 37) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244",
                           "44660V72811")))

dt_2020_38 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 38) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244",
                           "44660V72811")))

dt_2020_39 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 39) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "57279V320244",
                           "44660V72811")))

# ADD NEW WEEK HERE!


# Trp index
calculate_trp_index <- function(dt_base, dt_calc) {
  trp_daily_index <- inner_join(dt_base, dt_calc,
                            by = c("point_id", "weekday"),
                            suffix = c("_b", "_c")) %>% 
  mutate(index = round((total_volume_c / total_volume_b - 1) * 100, digits = 1)) %>% 
  left_join(norske_ukedager) %>% 
  select(point_id, ukedag, index) %>% 
  left_join(points, by = c("point_id" = "trp_id")) %>% 
  left_join(cities_points, by = c("point_id" = "trp_id")) %>% 
  select(ukedag, name, road_reference, city_area_name, index) %>% 
  tidyr::pivot_wider(names_from = ukedag,
                       values_from = index) %>% 
  arrange(city_area_name, road_reference)
}

# Compare week 2020 to same week 2019 ####
trp_dt_201927_202027 <- calculate_trp_index(dt_2019_27, dt_2020_27) 
trp_dt_201928_202028 <- calculate_trp_index(dt_2019_28, dt_2020_28)
trp_dt_201929_202029 <- calculate_trp_index(dt_2019_29, dt_2020_29)
trp_dt_201930_202030 <- calculate_trp_index(dt_2019_30, dt_2020_30)
trp_dt_201931_202031 <- calculate_trp_index(dt_2019_31, dt_2020_31)
trp_dt_201932_202032 <- calculate_trp_index(dt_2019_32, dt_2020_32)
trp_dt_201933_202033 <- calculate_trp_index(dt_2019_33, dt_2020_33)
trp_dt_201934_202034 <- calculate_trp_index(dt_2019_34, dt_2020_34)
trp_dt_201935_202035 <- calculate_trp_index(dt_2019_35, dt_2020_35)
trp_dt_201936_202036 <- calculate_trp_index(dt_2019_36, dt_2020_36)
trp_dt_201937_202037 <- calculate_trp_index(dt_2019_37, dt_2020_37)
trp_dt_201938_202038 <- calculate_trp_index(dt_2019_38, dt_2020_38)
trp_dt_201939_202039 <- calculate_trp_index(dt_2019_39, dt_2020_39)



# City index ####
calculate_city_index <- function(dt_base, dt_calc) {
  city_daily_index <- inner_join(dt_base, dt_calc,
                            by = c("point_id", "weekday"),
                            suffix = c("_b", "_c")) %>% 
  left_join(cities_points, by = c("point_id" = "trp_id")) %>% 
  group_by(weekday, city_area_name) %>% 
  summarise(city_volume_b = sum(total_volume_b),
            city_volume_c = sum(total_volume_c),
            no_trp = n()
            ) %>% 
  mutate(index = round((city_volume_c / city_volume_b - 1) * 100, 
                       digits = 1)) %>% 
  left_join(norske_ukedager) %>% 
  select(city_area_name, ukedag, no_trp, index)
}



# Compare this week to same week 2019
city_dt_201927_202027 <- calculate_city_index(dt_2019_27, dt_2020_27) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "27")

city_dt_201928_202028 <- calculate_city_index(dt_2019_28, dt_2020_28) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "28")

city_dt_201929_202029 <- calculate_city_index(dt_2019_29, dt_2020_29) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "29")

city_dt_201930_202030 <- calculate_city_index(dt_2019_30, dt_2020_30) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "30")

city_dt_201931_202031 <- calculate_city_index(dt_2019_31, dt_2020_31) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "31")

city_dt_201932_202032 <- calculate_city_index(dt_2019_32, dt_2020_32) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "32")

city_dt_201933_202033 <- calculate_city_index(dt_2019_33, dt_2020_33) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "33")

city_dt_201934_202034 <- calculate_city_index(dt_2019_34, dt_2020_34) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "34")

city_dt_201935_202035 <- calculate_city_index(dt_2019_35, dt_2020_35) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "35")

city_dt_201936_202036 <- calculate_city_index(dt_2019_36, dt_2020_36) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "36")

city_dt_201937_202037 <- calculate_city_index(dt_2019_37, dt_2020_37) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "37")

city_dt_201938_202038 <- calculate_city_index(dt_2019_38, dt_2020_38) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "38")

city_dt_201939_202039 <- calculate_city_index(dt_2019_39, dt_2020_39) %>% 
  filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "39")

#Cities week by week
city_dt_2019_2020_weeks = bind_rows(city_dt_201939_202039,
                                    city_dt_201938_202038,
                                    city_dt_201937_202037,
                                    city_dt_201936_202036,
                                    city_dt_201935_202035,
                                    city_dt_201934_202034,
                                    city_dt_201933_202033,
                                    city_dt_201932_202032,
                                    city_dt_201931_202031,
                                    city_dt_201930_202030,
                                    city_dt_201929_202029,
                                    city_dt_201928_202028,
                                    city_dt_201927_202027
                                   )

oslo_og_akershus_dt_2019_2020 <- city_dt_2019_2020_weeks %>% 
  filter(city_area_name == "Oslo og Akershus") %>% 
  select(weekday, ukedag, no_trp, index, weekno)

bergen_dt_2019_2020 <- city_dt_2019_2020_weeks %>% 
  filter(city_area_name == "Bergen") %>% 
  select(weekday, ukedag, no_trp, index, weekno)

nord_jaeren_dt_2019_2020 <- city_dt_2019_2020_weeks %>% 
  filter(city_area_name == "Nord-Jæren") %>% 
  select(weekday, ukedag, no_trp, index, weekno)

trondheim_dt_2019_2020 <- city_dt_2019_2020_weeks %>% 
  filter(city_area_name == "Trondheim") %>% 
  select(weekday, ukedag, no_trp, index, weekno)

tromsoe_dt_2019_2020 <- city_dt_2019_2020_weeks %>% 
  filter(city_area_name == "Tromsø") %>% 
  select(weekday, ukedag, no_trp, index, weekno)

## One week per city
# bergen_dt_2019_2020_28 = bergen_dt_2019_2020 %>% 
#   filter(weekno == "28")
# 
# oslo_og_akershus_dt_2019_2020_28 = oslo_og_akershus_dt_2019_2020 %>% 
#   filter(weekno == "28")
# 
# nord_jaeren_dt_2019_2020_28 = nord_jaeren_dt_2019_2020 %>% 
#   filter(weekno == "28")
# 
# trondheim_dt_2019_2020_28 = trondheim_dt_2019_2020 %>% 
#   filter(weekno == "28")
# 
# tromsoe_dt_2019_2020_28 = tromsoe_dt_2019_2020 %>% 
#   filter(weekno == "28")


# Function for generating table ####
make_city_table <- function(city_dt, caption_text) {
  
  city_dt_table_ready <- city_dt %>%
    dplyr::ungroup() %>% 
    dplyr::select(-weekday, -no_trp) %>%
    dplyr::mutate(index = dplyr::na_if(index, "Inf")) %>% 
    tidyr::pivot_wider(names_from = ukedag,
                values_from = index)
  
  ncol_dt <- ncol(city_dt_table_ready)
  
  city_table <- city_dt_table_ready %>% 
    flextable() %>%
    set_header_labels(city_area_name = "Byområde") %>%
    bold(part = "header") %>%
    fontsize(size = 9, part = "all") %>%
    font(fontname = "Lucida Sans Unicode", part = "all") %>%
    bg(bg = "#ED9300", part = "header") %>%
    border_remove() %>%
    hline_top(part = "header", border = borderline) %>%
    hline_bottom(part = "all", border = borderline) %>%
    colformat_num(j = 2:ncol_dt, na_str = "", digits = 1) %>% 
    autofit() %>%
    height_all(height = .2) %>%
    padding(padding.top = .3,
            padding.bottom = .3) %>%
    set_caption(caption_text)
  
  return(city_table)
}

make_city_table_city <- function(city_dt, caption_text) {
  
  city_dt_table_ready <- city_dt %>%
    dplyr::ungroup() %>% 
    dplyr::select(-weekday, -no_trp) %>%
    dplyr::mutate(index = dplyr::na_if(index, "Inf")) %>% 
    tidyr::pivot_wider(names_from = ukedag,
                values_from = index)
  
  ncol_dt <- ncol(city_dt_table_ready)
  
  city_table <- city_dt_table_ready %>% 
    flextable() %>%
    set_header_labels(weekno = "Uke") %>%
    bold(part = "header") %>%
    fontsize(size = 9, part = "all") %>%
    font(fontname = "Lucida Sans Unicode", part = "all") %>%
    bg(bg = "#ED9300", part = "header") %>%
    border_remove() %>%
    hline_top(part = "header", border = borderline) %>%
    hline_bottom(part = "all", border = borderline) %>%
    colformat_num(j = 2:ncol_dt, na_str = "", digits = 1) %>% 
    autofit() %>%
    height_all(height = .2) %>%
    padding(padding.top = .3,
            padding.bottom = .3) %>%
    set_caption(caption_text)
  
  return(city_table)
}

make_daily_plot_city <- function(area_dt, subtitle_text) {
  
  area_dt %>%
  ggplot2::ggplot(aes(ukedag, index)) +
  geom_bar(aes(fill = index > 0), stat = "identity",
           color = "#000000", 
           alpha = 0.6) +
  scale_fill_manual(guide = FALSE, breaks = c(FALSE, TRUE), 
                    values = c("#ed1c2e", "#58b02c")) +
  geom_hline(yintercept = 0, color = "#000000") +
  facet_grid(weekno ~., switch = "y") +
  scale_y_continuous(position = "right",
                     limits = c(-20, 20),
                     breaks = c(-10, 0, 10)) +
  xlab("") +
  ylab("Endring i trafikkmengde (%)\n") +
  ggtitle(label = "Daglig endring i trafikkmengde",
          subtitle = subtitle_text) +
  theme(strip.text.y = element_text(angle = 180),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank()) +
  labs(caption = "Data: Statens vegvesen")
}
```


# Bakgrunn

Som følge av smitteverntiltak i forbindelse med spredningen av det nye koronaviruset SARS-CoV-2, er det interessant å se hvordan trafikken endret seg. De første tiltakene ble annonsert av Regjeringen torsdag 12. mars 2020 (uke 11), og trådde i kraft fredag 13. mars.

Datagrunnlaget for beregningene hentes fra trafikkregistreringspunktene som inngår i byindeksene. Det vil gi et representativ utvalg for å kunne beregne trafikkutviklingen. Det gjøres en sammenligning av døgntrafikken, ukedag mot ukedag. Mandag sammenlignes med mandag osv.  

For å få et best mulig bilde av trafikkutviklingen sammenligninges her døgntrafikken sammenlignes med tilsvarende døgntrafikk i samme uke i 2019.

Denne rapporten viser tall fra og med uke 27. Trafikkutvikling for tidligere uker finnes i egen rapport for uke 10-26.

Alle data er hentet fra [trafikkdata.no](https://www.trafikkdata.no/). Døgntrafikk med minst 99 % dekningsgrad er brukt til å beregne prosentvis endring mellom to dager.

Vi tar forbehold om feil i datagrunnlaget. Enkelte trafikkregistreringspunkter er utelatt på grunn av feil på utstyr eller at de ligger på veier som er påvirket av vegarbeid o.l. Datagrunnlaget inkluderer likevel mange nok punkter til å få fram en generell trend i trafikkutviklingen.

Været vil enkelte dager kunne påvirke trafikkmengden. For eksempel vil det ved dårlig føre, som ved stort snøfall eller underkjølt regn, bli redusert framkommelighet og dette fører til mindre trafikk enn normalt.



# Endring i trafikk fra 2019 til 2020


## Bergen
```{r table_city_bergen}
make_city_table_city(bergen_dt_2019_2020,
                "Prosentvis endring i trafikkmengde i Bergen 2019 til 2020.")
```
\
```{r plot_city_bergen, fig.width=8, fig.height=11}
make_daily_plot_city(bergen_dt_2019_2020, "")
```

## Nord-Jæren
```{r table_city_nord-jaeren}
make_city_table_city(nord_jaeren_dt_2019_2020,
                "Prosentvis endring i trafikkmengde i Nord-Jæren 2019 til 2020.")
```
\
```{r plot_city_nord_jaeren, fig.width=8, fig.height=11}
make_daily_plot_city(nord_jaeren_dt_2019_2020, "")
```

## Oslo og Akershus
```{r table_city_oslo_akershus}
make_city_table_city(oslo_og_akershus_dt_2019_2020,
                "Prosentvis endring i trafikkmengde i Oslo og Akershus 2019 til 2020.")
```
\
```{r plot_city_oslo_og_akershus, fig.width=8, fig.height=11}
make_daily_plot_city(oslo_og_akershus_dt_2019_2020, "")
```

## Tromsø
```{r table_city_tromsoe}
make_city_table_city(tromsoe_dt_2019_2020,
                "Prosentvis endring i trafikkmengde i Tromsø 2019 til 2020.")
```
\
```{r plot_city_tromsoe, fig.width=8, fig.height=11}
make_daily_plot_city(tromsoe_dt_2019_2020, "")
```

## Trondheim
```{r table_city_trondheim}
make_city_table_city(trondheim_dt_2019_2020,
                "Prosentvis endring i trafikkmengde i Trondheim 2019 til 2020.")
```
\
```{r plot_city_trondheim, fig.width=8, fig.height=11}
make_daily_plot_city(trondheim_dt_2019_2020, "")
```





