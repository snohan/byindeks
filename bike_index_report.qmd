---
format: 
  pdf:
    toc: true
    number-sections: true
    toc-title: Innhold
    mainfont: "Lucida Sans Unicode"
    include-in-header:
      text: |
        \newfontfamily\sectionfont[Color=ed9300]{Lucida Sans Unicode}
        \newfontfamily\subsectionfont[Color=444f55]{Lucida Sans Unicode}
        \newfontfamily\subsubsectionfont[Color=ed9300]{Lucida Sans Unicode}
        \addtokomafont{section}{\sectionfont}
        \addtokomafont{subsection}{\subsectionfont}
        \addtokomafont{subsubsection}{\subsubsectionfont}
        \usepackage[font=small,textfont=it,labelsep=period]{caption}
crossref: 
  tbl-title: "Tabell"
  lot-title: "Tabeller"
  tbl-prefix: ""
  fig-title: "Figur"
  lof-title: "Figurer"
  fig-prefix: ""
  title-delim: "."
---

```{r}
#| label: setup
#| include: false
#| echo: false

source("rmd_setup.R")

last_published_month_number <- 5

index_all_years <-
  readr::read_rds(
    file = "data_indexpoints_tidy/bike_index_all_long.rds"
  ) |> 
  dplyr::filter(
      compared_to_ref_year == TRUE
  ) |> 
  dplyr::mutate(
    years = paste0(year_base, "-", year),
    month_name = lubridate::make_date(year, month, 1) |> lubridate::month(label = TRUE),
    months = paste0("jan-", month_name)
  )

# Reference year as zero in plots
reference_year_as_zero <-
  index_all_years |> 
  dplyr::select(
    area_name,
    year = reference_year,
    months
  ) |> 
  dplyr::distinct() |> 
  dplyr::mutate(
    index_p = 0,
    ci_lower = 0,
    ci_upper = 0,
    #month = list(tibble::tibble(month = c(last_published_month_number, 12)))
  ) #|> 
  #tidyr::unnest(month)

index_for_plotting <-
  index_all_years |> 
  dplyr::select(
    area_name,
    year,
    months,
    index_p,
    ci_lower,
    ci_upper
  ) |> 
  dplyr::bind_rows(
    reference_year_as_zero
  ) |> 
  dplyr::arrange(
    area_name,
    months,
    year
  )






city_and_color <-
  c(
    "Bergen" = "#008ec2",
    "Førde" = "#ffd520",
    "Nord-Jæren" = "#ed9300",
    "Grenland" = "#444f55",
    "Nedre Glomma" = "#58b02c",
    "Osloområdet" = "#ed1c2e",
    "Tromsø" = "#dadada"
  )
```

\listoftables

\listoffigures

{{< pagebreak >}}


# Om sykkelindekser
Sykkelindeksene er en type vegtrafikkindeks for sykkeltrafikk. De estimerer endringen i antall syklende i prosent fra et år til det neste. Endringen over flere år beregnes ved hjelp av en sammekjeding av disse indeksene.

En sykkelindeks beregnes for de byområdene som har et tilstrekkelig antall sykkelregistreringspunkter med god datakvalitet. Det vil gi et representativt utvalg for å kunne beregne trafikkutviklingen. Det gjøres en sammenligning av timetrafikken, dato mot dato i kalendermånedene.

Alle data er hentet fra [www.vegvesen.no/trafikkdata/](https://www.vegvesen.no/trafikkdata/). Timetrafikk med minst 95 % dekningsgrad inngår i beregningsgrunnlaget.

Det tas forbehold om feil i datagrunnlaget. Enkelte trafikkregistreringspunkter er tidvis utelatt på grunn av feil på utstyr eller at de ligger på veier som er påvirket av vegarbeid eller omskilting o.l. Datagrunnlaget inkluderer likevel mange nok punkter til å få fram en generell trend i trafikkutviklingen.

Været vil i perioder kunne påvirke trafikkmengden. For eksempel vil det ved dårlig føre, som ved stort snøfall eller underkjølt regn, bli redusert framkommelighet og dette fører til mindre trafikk enn normalt.


## Antall sykkelregistreringspunkter
I tabellene i denne rapporten angis antall sykkelregistreringspunkter for det året som hadde færrest punkt blant årene som inngår i indekskjeden. Det er dette antallet som er bestemmende for bredden på indeksens konfidensintervall, og indekskjeden er sånn sett preget av det "svakeste" leddet i kjeden.


# Bergen

```{r}
#| label: tbl-brg
#| tbl-cap: "Estimert endring i sykkeltrafikk i Bergen."
#| ft.arraystretch: 0.9

table_index_chains("Bergen")
```



```{r}
#| label: fig-brg
#| fig-width: 6.5
#| fig-height: 6
#| fig-cap: "Estimert endring i sykkeltrafikk i Bergen."

index_for_plotting |> 
   dplyr::filter(
      area_name == "Bergen"
    ) |>
  ggplot2::ggplot(aes(x = year, y = index_p)) +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  facet_grid(rows = vars(months))
  theme_light()

# index_all_years %>% 
#   dplyr::filter(period == "year_to_date") %>% 
#   dplyr::group_by(area_name, year) %>% 
#   dplyr::slice_max(month_object) %>% 
#   ggplot2::ggplot(aes(x = year, y = index_p, color = area_name)) +
#   ggplot2::geom_line() +
#   ggplot2::geom_point() +
#   theme_light() +
#   theme(
#     axis.title.y = element_text(
#       margin = margin(t = 0, r = 15, b = 0, l = 0)),
#     panel.grid.minor.x = element_blank(),
#     plot.caption =
#       element_text(
#         face = "italic",
#         size = 8,
#         lineheight = 1.5,
#         vjust = 0
#       )
#   ) +
#   scale_color_manual(
#     values = city_and_color,
#     name = ""
#   ) +
#   labs(x = NULL, y = "Endring i trafikkmengde (%) \n",
#        caption = "Data: Statens vegvesen, fylkeskommunene og kommunene") +
#   ggtitle("Estimert endring i sykkeltrafikk i utvalgte byområder",
#           subtitle = "Antall syklende sammenlignet med foregående år") +
#   theme(legend.position = "bottom")
```


# Førde

```{r}
#| label: tbl-frd
#| tbl-cap: "Estimert endring i sykkeltrafikk i Førde."
#| ft.arraystretch: 0.9

table_index_chains("Førde")
```



```{r}
#| label: fig-month
#| fig-width: 6.5
#| fig-height: 6
#| fig-cap: "Estimert månedlig endring i sykkeltrafikk."

# index_all_years %>% 
#   dplyr::filter(period == "month") %>% 
#   ggplot2::ggplot(aes(x = month_object_2000, y = index_p, color = area_name)) +
#   ggplot2::geom_line() +
#   ggplot2::geom_point() +
#   facet_grid(rows = vars(year)) +
#   theme_light() +
#   theme(
#     axis.text.x = element_text(angle = 90, vjust = 0.5),
#     axis.title.y = element_text(
#       margin = margin(t = 0, r = 15, b = 0, l = 0)),
#     panel.grid.minor.x = element_blank(),
#     plot.caption =
#       element_text(
#         face = "italic",
#         size = 8,
#         lineheight = 1.5,
#         vjust = 0
#       )
#   ) +
#   scale_x_date(breaks = scales::breaks_width("months"),
#                labels = scales::label_date("%b")) +
#   scale_color_manual(values = city_and_color,
#                      name = "") +
#   labs(x = NULL, y = "Endring i trafikkmengde (%) \n",
#        caption = "Data: Statens vegvesen, fylkeskommunene og kommunene") +
#   ggtitle("Estimert endring i sykkeltrafikk i utvalgte byområder",
#           subtitle = "Antall syklende sammenlignet med samme måned foregående år") +
#   theme(legend.position = "bottom")
```



