---
#title: Trafikkutvikling i byområder
output: 
  html_document:
    toc: true
    fig_caption: true
  # word_document:
  #   reference_docx: svv_notatmal.docx
  #   toc: true
  #   toc_depth: 2
  #   fig_caption: true
  #   fig_width: 7
---

```{r setup, include = FALSE}
source("rmd_setup.R")
```

```{r points, include = FALSE}
all_point_info <- 
  read.csv2("data_indexpoints_tidy/indekspunktene_trondheim_2018.csv") %>% 
  dplyr::arrange(Vegreferanse) %>% 
  dplyr::rename(Stasjonstype = Type)
```

# Bakgrunn

Bymiljøavtalen som ble inngått i 2016 mellom Trondheim kommune, Sør-Trøndelag fylkeskommune og Staten gjaldt for perioden 2016-2023. Målet med avtalen var at veksten i persontransporten skal tas med kollektivtrafikk, sykling og gåing («nullvekstmålet»). Området avtalen gjaldt for var Trondheim kommune.

Byindeksen er en av målindikatorene og den estimerer endringen i biltrafikk. Byindeksen er en trafikkindeks for vegtrafikk basert på registreringer fra faste trafikkregistreringspunkter og bomstasjoner fordelt på riksveger, fylkesveger og kommunale veger. Trafikkindeksen skal gi et representativt bilde av trafikkutviklingen i avtaleområdet.

Byindeksen gjelder for "lette" biler. Lette biler er her definert å være målt til kortere enn 5,6 m i Statens vegvesens trafikkregistreringsstasjoner, og i data fra bomstasjonene er det kategorien "lette kjøretøy" som benyttes. Lettere næringstransport skal i teorien være er tatt ut av trafikkindeksen da det er unntatt fra nullvekstmålet. Det samme gjelder for gjennomgangstrafikk. Disse to kategoriene trafikk er likevel ikke mulig å skille ut av datamaterialet da det ikke foreligger noe informasjon i registreringene som skiller de fra øvrig trafikk med lette biler.

(Bymiljøavtalen for Trondheim kommune ble i 2019 erstattet av en byvekstavtale for Trondheimsområdet som gjelder for 2019-2029.)

\newline

## Byindekspunktenes plassering
I Trondheim er det benyttet et utvalg av eksisterende trafikkregistreringsstasjoner og bomstasjoner som til sammen dekker det meste av vegnettet. Kartene nedenfor viser plasseringen av byindekspunktene.

\newline
\newline

```{r map_trp, fig.cap = "Plasseringen av byindekspunktene."}
palett_stasjonstype <- 
  colorFactor(palette = c("#db3b99", "#444f55"), 
              domain = c("Bom", "TRS"))

palett_adt <-
 colorNumeric(palette = "Greens",
              domain = NULL)

all_point_info %>%
  leaflet(width = "100%",
          options = leafletOptions(crs = nvdb_crs,
                                   zoomControl = F)) %>%
  addTiles(urlTemplate = nvdb_map_url,
           attribution = nvdb_map_attribution) %>%
  addCircleMarkers(
    radius = 6,
    stroke = T,
    weight = 2,
    color = ~palett_stasjonstype(Stasjonstype),
    opacity = 0.8,
    fill = T,
    fillColor = ~palett_adt(ADT),
    fillOpacity = 0.8
  ) %>%
  addLegend("bottomleft",
            pal = palett_stasjonstype,
            values = ~Stasjonstype,
            title = "Stasjonstype",
            opacity = 0.7) %>%
  addLegend("bottomright",
            pal = palett_adt,
            values = ~ADT,
            title = "ÅDT",
            opacity = 0.7,
            labFormat = labelFormat(big.mark = " "))
```

# Byindeksen 2018

**Byindeksen for Trondheim estimerer endringen i trafikkmengden fra 2017 til 2018 til 0,0 % med et 95 %-konfidensintervall på ± 3,2 %.** Figuren nedenfor viser endringen i byindekspunktene.

```{r map_trp_index, fig.cap="Endring i trafikkmengde på punktene."}
all_point_info %>%
  leaflet(width = "100%",
          options = leafletOptions(crs = nvdb_crs,
                                   zoomControl = F)) %>%
  addTiles(urlTemplate = nvdb_map_url,
           attribution = nvdb_map_attribution) %>%
  addCircleMarkers(
    radius = 6,
    stroke = T,
    weight = 2,
    color = "#444f55",
    opacity = 0.8,
    fill = T,
    fillColor = ~palett_adt(Indeks),
    fillOpacity = 0.8
  ) %>%
  addLegend("bottomright",
            pal = palett_adt,
            values = ~Indeks,
            title = "Indeks",
            opacity = 0.7,
            labFormat = labelFormat(big.mark = " "))
```


Tabellen nedenfor gjengir byindekspunktene og deres indeksverdi for 2018. ÅDT er fra 2017.

\newline

```{r table}
all_point_info %>% 
  select(Stasjonnr, Navn, Veg, Stasjonstype, ADT, Indeks) %>% 
  flextable() %>% 
  colformat_num(col_keys = "ADT", 
                big.mark = " ", digits = 0) %>%
  colformat_num(col_keys = c("Indeks"), digits = 1) %>%
  set_header_labels(ADT = "ÅDT") %>% 
  bold(part = "header") %>% 
  fontsize(size = 9, part = "all") %>% 
  font(fontname = "Lucida Sans Unicode", part = "all") %>% 
  bg(bg = "#ED9300", part = "header") %>% 
  autofit() %>% 
  height_all(height = .2) %>% 
  padding(padding.top = .3,
          padding.bottom = .3)
```


I figuren nedenfor er spredningen i punktindeksene illustrert. Den horisontale grønne streken viser byindeksens samlede verdi for 2018.

\newline

```{r graph, fig.cap = "Spredningen i punktindeksene."}
all_point_info_index <- all_point_info %>% 
  dplyr::filter(!is.na(Indeks)) 

ggplot2::ggplot() +
  geom_point(data = all_point_info_index, 
             aes(x = reorder(Navn, Indeks), y = Indeks, size = ADT),
             color = "#ED9300") +
  geom_hline(yintercept = 0, color = "#58B02C") +
  xlab("") +
  ylab("Endring (%)") +
  ggtitle(label = "Endring i trafikkmengde",
          subtitle = "Fra 2017 til 2018") +
  coord_flip() +
  scale_size(name = "ÅDT 2017") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -3.2, ymax = 3.2),
            alpha = 0.1, fill = "#008EC2") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

Blant punktindeksene skiller Tillerbrua på Fv6680 seg ut med sine 68,5 %. Dette skyldes delvis anleggsarbeid på Fv6680 i 2017, samt på Fv704 mellom Trondheim og Klæbu gjennom hele året unntatt desember. Fv704 var helt stengt i 8 uker på sommeren 2017 og 2018. Mye av trafikken gikk derfor via Fv6680 og Tillerbrua. Vi ser en tilsvarende nedgang på Torgårdsletta på Fv704 med -10,9 %. Til sammen fanger de to bomstasjonene her opp den totale trafikken mellom Trondheim og Klæbu.

De øvrige punktindeksverdiene ligger relativt nært samlet rundt byindeksens samlede verdi på 0,0 %, illustrert med den vertikale, grønne streken. Byindeksen har et konfidensintervall på ± 3,2 %, og dette er illustrert med det lyseblå området.