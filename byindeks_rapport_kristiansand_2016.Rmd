---
#title: Trafikkutvikling i byområder
output: 
  # html_document:
  #   toc: true
  #   fig_caption: true
  word_document:
    reference_docx: svv_notatmal3.docx
    toc: true
    toc_depth: 2
    fig_caption: true
    fig_width: 7
---

```{r setup, include = FALSE, echo = FALSE}
source("rmd_setup.R")
```

```{r points, include = FALSE}
road_lengths <- read_road_length_csv("road_lengths/kristiansand_road_lengths.csv")

all_point_info <- 
  read.csv2("data_indexpoints_tidy/indekspunkt_kristiansand_2016.csv")

city_info <-
    read.csv2("data_indexpoints_tidy/byindeks_kristiansand_2016.csv")

city_monthly <- 
  read.csv2("data_indexpoints_tidy/byindeks_maanedlig_kristiansand_2016.csv")

city_36_month <- 
  read.csv2("data_indexpoints_tidy/byindeks_36_maaneder_kristiansand_2016.csv")

city_info_all_years <- city_info %>% 
  dplyr::filter(year == "2016-2020")

index_all_years <- round(city_info_all_years$index, digits = 1)
index_all_years_ci_lower <- 
  round(city_info_all_years$index - 
          city_info_all_years$konfidensintervall, digits = 1)
index_all_years_ci_upper <- 
  round(city_info_all_years$index + 
          city_info_all_years$konfidensintervall, digits = 1)

# Egen variant for KRS kommune, dvs. gamle kommunen før den ble 
# slått sammen med Songdalen og Søgne

all_point_info_kommune <- 
  read.csv2("data_indexpoints_tidy/indekspunkt_kristiansand_kommune_2016.csv")

city_info_kommune <-
    read.csv2("data_indexpoints_tidy/byindeks_kristiansand_kommune_2016.csv")

city_monthly_kommune <- 
  read.csv2("data_indexpoints_tidy/byindeks_maanedlig_kristiansand_kommune_2016.csv")

city_36_month_kommune <- 
  read.csv2("data_indexpoints_tidy/byindeks_36_maaneder_kristiansand_kommune_2016.csv")

city_info_all_years_kommune <- city_info_kommune %>% 
  dplyr::filter(year == "2016-2020")

index_all_years_kommune <- round(city_info_all_years_kommune$index, digits = 1)
index_all_years_ci_lower_kommune <- 
  round(city_info_all_years_kommune$index - 
          city_info_all_years_kommune$konfidensintervall, digits = 1)
index_all_years_ci_upper_kommune <- 
  round(city_info_all_years_kommune$index + 
          city_info_all_years_kommune$konfidensintervall, digits = 1)
```

```{r child = 'formaal.Rmd'}
```

## Områdeavgrensing og vegnett
For Kristiansand beregnes en byindeks for to ulike områder: Kristiansandområdet og gamle Kristiansand kommune.  Kristiansandområdet omfatter kommunene Kristiansand og Vennesla.

Veglengder fordelt på vegkatori for gjeldende område er oppsummert i tabellen nedenfor.

```{r road_length}
road_lengths %>% create_municipality_road_length_table()
```

```{r road_length_sum}
road_lengths %>% create_city_road_length_table()
```

```{r child = 'vegnett.Rmd'}
```


## Byindekspunktene
Trafikkregistreringspunktene som inngår i byindeksen er listet opp i følgende tabell.

```{r point_table}
all_point_info %>%
  select(name, road_reference, adt, year) %>%
  flextable() %>%
  colformat_num(j = "adt",
                big.mark = " ", digits = 0) %>%
  set_header_labels(name = "Navn",
                    road_reference = "Vegreferanse",
                    adt = "ÅDT",
                    year = "År") %>%
  align(i = 1, j = 3, align = "center", part = "header") %>%
  bold(part = "header") %>%
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Lucida Sans Unicode", part = "all") %>%
  bg(bg = "#ED9300", part = "header") %>%
  border_remove() %>%
  hline_top(part = "header", border = borderline) %>%
  hline_bottom(part = "all", border = borderline) %>%
  autofit() %>%
  height_all(height = .2) %>%
  padding(padding.top = .3,
          padding.bottom = .3) %>%
  set_caption("Trafikkregistreringspunktene som inngår i byindeksen. ÅDT er oppgitt for lette biler (målt til kortere enn 5,6 m), og gjelder for det første året i avtaleperioden med god datakvalitet.")
```


Kartet nedenfor viser plasseringen av trafikkregistreringspunktene som benyttes i byindeksen for Kristiansandområdet.

```{r map_trp}
create_point_adt_map(all_point_info)
```

Kartet nedenfor viser plasseringen av trafikkregistreringspunktene som benyttes i byindeksen for gamle Kristiansand kommune.

```{r map_trp_kommune}
create_point_adt_map(all_point_info_kommune)
```

# Endring i trafikkmengde

Nullvekstmålet skal måles ved at trafikkutviklingen vurderes på et treårs glidende snitt, jf. brev fra Samferdselsdepartementet til de fire største byområdene datert 11.12.2019. Måloppnåelsen gjelder fremdeles avtaleperioden sett under ett. Det skal være netto nullvekst i perioden.

Endring i trafikkmengde er beregnet for hver måned mellom to påfølgende år, med januar i året etter referanseåret som første månedsindeks. Glidende tre års indeks bruker de siste 36 månedsindeks som grunnlag.


## Endring i glidende treårsperiode

Først når månedsindeks er beregnet gjennom tre år eller lenger, kan det beregnes en glidende treårsindeks. Den vil så oppdateres månedlig. Den første treårsindeksen inkluderer derfor månedsindeksene fra og med januar 2017 til og med desember 2019.

```{r city_table_36}
create_city_36_index_table(city_36_month)
# TODO: CI
```
Tilsvarende for gamle Kristiansand kommune.

```{r city_table_36_kommune}
create_city_36_index_table(city_36_month_kommune)
# TODO: CI
```

## Endring per år
Endring i trafikkmengde er også beregnet for hele kalenderår. Tabellen nedenfor viser byindeksen for hvert år, samt for hele perioden.

Tabellen nedenfor viser byindeksen for hvert år, samt for hele perioden fra 2016 til april 2020.

```{r city_table}
create_city_index_table(city_info) %>% 
  set_caption("Estimert endring i trafikkmengde i Kristiansandområdet.")
```

```{r city_table_kommune}
create_city_index_table(city_info_kommune) %>% 
  set_caption("Estimert endring i trafikkmengde i gamle Kristiansand kommune.")
```


\newline
**Byindeksen estimerer endringen i trafikkmengden i Kristiansandområdet fra 
2016 til april 2020
til å være 
`r stringr::str_replace(as.character(index_all_years), "\\.", ",")` %.**
Usikkerheten knyttet til byindeksen gjenspeiles i et 95 % konfidensintervall som er fra
`r stringr::str_replace(as.character(index_all_years_ci_lower), "\\.", ",")` % til
`r stringr::str_replace(as.character(index_all_years_ci_upper), "\\.", ",")` %.

**Byindeksen estimerer endringen i trafikkmengden i gamle Kristiansand kommune fra 
2016 til april 2020
til å være 
`r stringr::str_replace(as.character(index_all_years_kommune), "\\.", ",")` %.**
Usikkerheten knyttet til byindeksen gjenspeiles i et 95 % konfidensintervall som er fra
`r stringr::str_replace(as.character(index_all_years_ci_lower_kommune), "\\.", ",")` % til
`r stringr::str_replace(as.character(index_all_years_ci_upper_kommune), "\\.", ",")` %.



```{r all_point_info_long}
all_point_info_long <- all_point_info %>% 
  dplyr::select(name, road_category_and_number, starts_with("index")) %>% 
  tidyr::pivot_longer(starts_with("index"), 
                      names_to = "period", 
                      values_to = "index_value") %>% 
  dplyr::mutate(year = case_when(period == "index" ~ "2016-2020",
                                 period == "index_17" ~ "2016-2017",
                                 period == "index_18" ~ "2017-2018",
                                 period == "index_19" ~ "2018-2019",
                                 period == "index_20" ~ "2019-2020"),
                year = factor(year, levels = c("2016-2020",
                                               "2019-2020",
                                               "2018-2019",
                                               "2017-2018",
                                               "2016-2017"
                                               ),
                                ordered = TRUE))

all_point_info_long_kommune <- all_point_info_kommune %>% 
  dplyr::select(name, road_category_and_number, starts_with("index")) %>% 
  tidyr::pivot_longer(starts_with("index"), 
                      names_to = "period", 
                      values_to = "index_value") %>% 
  dplyr::mutate(year = case_when(period == "index" ~ "2016-2020",
                                 period == "index_17" ~ "2016-2017",
                                 period == "index_18" ~ "2017-2018",
                                 period == "index_19" ~ "2018-2019",
                                 period == "index_20" ~ "2019-2020"),
                year = factor(year, levels = c("2016-2020",
                                               "2019-2020",
                                               "2018-2019",
                                               "2017-2018",
                                               "2016-2017"
                                               ),
                                ordered = TRUE))
```

Nedenfor vises en graf over byindeksene for hver periode, sammen med alle punktindeksene.
\newline

```{r plot_city_index}
set.seed(123) # To keep the jittering the same for each render of the plot

city_info_each_one_year_and_total <- city_info 

ggplot() +
  geom_jitter(data = all_point_info_long,
              aes(year, index_value),
              color = "#ED9300", size = 2, alpha = 0.3, width = 0.1) +
  geom_hline(yintercept = 0, alpha = 0.3) +
  geom_segment(data = city_info_each_one_year_and_total,
               aes(x = year, xend = year,
                   y = 0, yend = index),
               color = "#ED9300", size = 0.6, alpha = 0.9) +
  geom_point(data = city_info_each_one_year_and_total,
             aes(year, index),
             color = "#ED9300", size = 5, alpha = 0.9) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Endring i trafikkmengde (%)",
       caption = "Data: Statens vegvesen") +
  ggtitle("Estimert endring i trafikkmengde i Kristiansandområdet",
          subtitle = "Byindeksen (store prikker) og punktene (små prikker)")

```

```{r plot_city_index_kommune}
city_info_each_one_year_and_total_kommune <- city_info_kommune 

ggplot() +
  geom_jitter(data = all_point_info_long_kommune,
              aes(year, index_value),
              color = "#ED9300", size = 2, alpha = 0.3, width = 0.1) +
  geom_hline(yintercept = 0, alpha = 0.3) +
  geom_segment(data = city_info_each_one_year_and_total_kommune,
               aes(x = year, xend = year,
                   y = 0, yend = index),
               color = "#ED9300", size = 0.6, alpha = 0.9) +
  geom_point(data = city_info_each_one_year_and_total_kommune,
             aes(year, index),
             color = "#ED9300", size = 5, alpha = 0.9) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Endring i trafikkmengde (%)",
       caption = "Data: Statens vegvesen") +
  ggtitle("Estimert endring i trafikkmengde i gamle Kristiansand kommune",
          subtitle = "Byindeksen (store prikker) og punktene (små prikker)")

```

Kartet nedenfor viser endringen i byindekspunktene fra referanseåret 2016 til april 2020.

Kristiansandområdet:

```{r map_trp_index}
create_pointindex_map(all_point_info)
```

Gamle Kristiansand kommune:

```{r map_trp_index_kommune}
create_pointindex_map(all_point_info_kommune)
```

Tabellen nedenfor gjengir byindekspunktene og deres indeksverdi.

\newline

```{r point_index_table}
index_column_names <- all_point_info %>% 
  select(starts_with("index")) %>% 
  names()

all_point_info %>%
  select(name, road_category_and_number, starts_with("index")) %>%
  flextable() %>%
  colformat_num(j = index_column_names,
                digits = 1) %>%
  set_header_labels(name = "Navn",
                    road_category_and_number = "Veg",
                    index_17 = "Endring i trafikkmengde (%)") %>%
  add_header_row(values = c("", "",
                            "2016", "2017", "2018",
                            "2019", "2016"), top = F) %>%
  add_header_row(values = c("", "",
                            "-2017", "-2018", "-2019",
                            "-2020", "-2020"), top = F) %>%
  merge_at(i = 1, j = 3:7, part = "header") %>%
  align(i = 1, j = 3, align = "center", part = "header") %>%
  align(i = 2, j = 3:7, align = "right", part = "header") %>%
  align(i = 3, j = 3:7, align = "right", part = "header") %>%
  bold(part = "header") %>%
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Lucida Sans Unicode", part = "all") %>%
  bg(bg = "#ED9300", part = "header") %>%
  border_remove() %>%
  hline_top(part = "header", border = borderline) %>%
  hline_bottom(part = "all", border = borderline) %>%
  autofit() %>%
  height_all(height = .2) %>%
  padding(padding.top = .3,
          padding.bottom = .3) %>%
  width(j = 5, width = 1) %>%
  set_caption("Estimert endring i trafikkmengde ved trafikkregistreringspunktene.")
```

\newline

I figuren nedenfor er spredningen i punktindeksene illustrert. Den horisontale grønne streken viser byindeksens samlede verdi for perioden 2016 - april 2020.

\newline

```{r point_graph, fig.width=8, fig.height=8}
all_point_info_index <- all_point_info %>% 
  dplyr::filter(!is.na(index)) 

ggplot2::ggplot() +
  geom_point(data = all_point_info_index, 
             aes(x = reorder(name, index), y = index, size = adt),
             color = "#ED9300", alpha = 0.6) +
  geom_hline(yintercept = index_all_years, color = "#58B02C") +
  geom_hline(yintercept = 0, color = "#000000") +
  xlab("") +
  ylab("Endring i trafikkmengde (%)") +
  ggtitle(label = "ÅDT og endring i trafikkmengde i Kristiansandområdet",
          subtitle = "Fra 2016 til april 2020") +
  coord_flip() +
  scale_size(name = "ÅDT") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, 
                ymin = index_all_years_ci_lower, 
                ymax = index_all_years_ci_upper),
            alpha = 0.1, fill = "#008EC2") +
  theme_minimal() +
  theme(legend.position = "right",
        axis.text.y = element_text(size = 7)) +
  labs(caption = "Data: Statens vegvesen")
# TODO: Add explaining labels with ggforce?
```


```{r point_graph_kommune, fig.width=8, fig.height=8}
all_point_info_index_kommune <- all_point_info_kommune %>% 
  dplyr::filter(!is.na(index)) 

ggplot2::ggplot() +
  geom_point(data = all_point_info_index_kommune, 
             aes(x = reorder(name, index), y = index, size = adt),
             color = "#ED9300", alpha = 0.6) +
  geom_hline(yintercept = index_all_years_kommune, color = "#58B02C") +
  geom_hline(yintercept = 0, color = "#000000") +
  xlab("") +
  ylab("Endring i trafikkmengde (%)") +
  ggtitle(label = "ÅDT og endring i trafikkmengde i gamle Kristiansand kommune",
          subtitle = "Fra 2016 til april 2020") +
  coord_flip() +
  scale_size(name = "ÅDT") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, 
                ymin = index_all_years_ci_lower_kommune, 
                ymax = index_all_years_ci_upper_kommune),
            alpha = 0.1, fill = "#008EC2") +
  theme_minimal() +
  theme(legend.position = "right",
        axis.text.y = element_text(size = 7)) +
  labs(caption = "Data: Statens vegvesen")
# TODO: Add explaining labels with ggforce?
```

## Endring per måned

Tabellene viser endring i trafikk per måned, sammenlignet med samme måned året før.

```{r monthly_city_index}
create_monthly_city_index_table(city_monthly) %>% 
  set_caption("Estimert endring i trafikkmengde per måned i Kristiansandområdet.")
```

```{r monthly_city_index_kommune}
create_monthly_city_index_table(city_monthly_kommune) %>% 
  set_caption("Estimert endring i trafikkmengde per måned i gamle Kristiansand kommune.")
```
