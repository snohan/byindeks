---
title: Daglig oppfølging av trafikkutviklingen i de største byene
output: 
  word_document:
    reference_docx: svv_notatmal.docx
    toc: true
    toc_depth: 2
    fig_caption: true
    fig_width: 7
---

```{r setup, include = FALSE, echo = FALSE, warning=FALSE, message=FALSE}
# Packages are loaded through sourcing rmd_setup.R
source("rmd_setup.R")

# Traffic Data API calls to get points metadata and aadt
source("get_from_trafficdata_api.R")

# Points used in each city
cities_points <- read.csv2("data_points_raw/cities_points.csv") %>% 
  dplyr::filter(city_area_name %in% c("Bergen",
                                      "Nord-Jæren",
                                      "Oslo og Akershus",
                                      "Trondheim"),
                !is.na(trp_id)) %>% 
  dplyr::distinct(trp_id, .keep_all = TRUE) %>% 
  dplyr::select(city_area_name, trp_id) %>% 
  # Remove unusable trps
  dplyr::filter(!(trp_id %in% c("65625V41945",
                                "21801V72158",
                                "81008V41567",
                                "14772V41375")))

# All points from Traffic Data API
points <- get_points() %>%
  dplyr::select(trp_id, name, road_reference, municipality_name,
                lat, lon) %>%
  dplyr::distinct(trp_id, .keep_all = T)

# Adding metadata to trps
trps <- dplyr::left_join(cities_points, points) %>%
  dplyr::filter(!is.na(name)) %>% 
  dplyr::filter(!stringr::str_detect(road_reference, "KD"))

# Days we want
week_2019_from <- "2019-03-11T00:00:00+01:00"
week_2019_to <- "2019-03-18T00:00:00+01:00"

week_2020_from <- "2020-03-02T00:00:00+01:00"
week_2020_to <- "2020-03-12T00:00:00+01:00"

ukedager <- c("Mandag",
              "Tirsdag",
              "Onsdag",
              "Torsdag",
              "Fredag",
              "Lørdag",
              "Søndag")

norske_ukedager <- data.frame(weekday = c(1, 2, 3, 4, 5, 6, 7),
                              ukedag = ordered(ukedager,
                                               levels = ukedager))

# Fetch daily traffic from API
dt_2019 <- get_dt_for_trp_list(trps$trp_id,
                        week_2019_from,
                        week_2019_to)


dt_2020 <- get_dt_for_trp_list(trps$trp_id,
                               week_2020_from,
                               week_2020_to)


dt <- bind_rows(dt_2019, dt_2020) %>%
  select(-point_name) %>%
  mutate(year = lubridate::year(from),
         weekno = lubridate::isoweek(from),
         weekday = lubridate::wday(from,
                                   week_start = getOption("lubridate.week.start", 1))) %>%
  select(-from) %>% 
  filter(coverage > 99)

# Trp index
# Compare this week to 2020 week 10
trp_dt_2020_week_10 <- dt %>%
  filter(year == 2020) %>%
  pivot_wider(id_cols = c(point_id, weekday),
              names_from = weekno,
              values_from = total_volume,
              names_prefix = "week_",
              values_fill = list(total_volume = NA)) %>%
  mutate(index = round((week_11 / week_10 - 1) * 100, digits = 1)) %>% 
  left_join(norske_ukedager) %>% 
  select(point_id, ukedag, index) %>% 
  left_join(points, by = c("point_id" = "trp_id")) %>% 
  left_join(cities_points, by = c("point_id" = "trp_id")) %>% 
  select(ukedag, name, road_reference, city_area_name, index)

# TODO: compare this week to same week 2019

# TODO: city index
# Compare this week to 2020 week 10
city_dt_2020_week_10 <- dt %>% 
  filter(year == 2020) %>%
  select(-year) %>% 
  left_join(cities_points, by = c("point_id" = "trp_id")) %>% 
  group_by(weekno, weekday, city_area_name) %>% 
  summarise(city_volume = sum(total_volume)) %>% 
  pivot_wider(id_cols = c(city_area_name, weekday),
              names_from = weekno,
              values_from = city_volume,
              names_prefix = "week_",
              values_fill = list(city_volume = NA)) %>%
  mutate(index = round((week_11 / week_10 - 1) * 100, digits = 1)) %>% 
  left_join(norske_ukedager) %>% 
  select(city_area_name, ukedag, index)


# TODO: compare this week to same week 2019

```

# Bakgrunn

Datagrunnlaget for beregningene hentes fra trafikkregistreringspunktene som inngår i byindeksene. Det vil gi ett representativ utvalg for å kunne beregne trafikkutviklingen.
Det gjøres en sammenligning av døgntrafikken, ukedag mot ukedag. Mandag sammenlignes med mandag osv.  For å få et best mulig bilde av trafikkutviklingen gjøres to sammenligner.  Døgntrafikken sammenlignes med tilsvarende døgntrafikk i uke 10 i 2020 og tilsvarende uke i 2019.
Trafikkutviklingen vil være tilgjengelig kl 10 hver arbeidsdag.

Alle data er hentet fra [trafikkdata.no](www.trafikkdata.no).


# Samlet endring i byene
```{r city_graph, fig.width=8, fig.height=8}
city_dt_2020_week_10 %>%
  ggplot2::ggplot(aes(ukedag, index)) +
  geom_bar(aes(fill = index < 0), stat = "identity",
           color = "#000000", 
           alpha = 0.6) +
  scale_fill_manual(guide = FALSE, breaks = c(TRUE, FALSE), 
                    values = c("#58b02c", "#ed1c2e")) +
  geom_hline(yintercept = 0, color = "#000000") +
  facet_grid(city_area_name ~., switch = "y") +
  scale_y_continuous(position = "right") +
  xlab("") +
  ylab("Endring i trafikkmengde (%)\n") +
  ggtitle(label = "Daglig endring i trafikkmengde",
          subtitle = "Fra uke 10 2020 til uke 11 2020") +
  theme(strip.text.y = element_text(angle = 180),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank()) +
  labs(caption = "Data: Statens vegvesen")
```

# Mer detaljer om hver by

## Trondheim

```{r point_graph, fig.width=8, fig.height=12}
trp_dt_2020_week_10 %>%
  filter(city_area_name == "Trondheim") %>% 
  mutate(name_road = paste0(name, "\n ", road_reference)) %>% 
  ggplot2::ggplot(aes(ukedag, index)) +
  geom_bar(aes(fill = index < 0), stat = "identity",
           color = "#000000", 
           alpha = 0.6) +
  scale_fill_manual(guide = FALSE, breaks = c(TRUE, FALSE), 
                    values = c("#58b02c", "#ed1c2e")) +
  geom_hline(yintercept = 0, color = "#000000") +
  facet_grid(name_road ~., switch = "y") +
  scale_y_continuous(position = "right") +
  xlab("") +
  ylab("Endring i trafikkmengde (%)\n") +
  ggtitle(label = "Daglig endring i trafikkmengde",
          subtitle = "Fra uke 10 2020 til uke 11 2020") +
  theme(strip.text.y = element_text(angle = 180),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank()) +
  labs(caption = "Data: Statens vegvesen")
```





```{r table}
trp_dt_2020_week_10 %>%
  filter(city_area_name == "Trondheim") %>% 
  pivot_wider(names_from = ukedag,
              values_from = index) %>% 
  select(-city_area_name) %>% 
  #select(name, road_reference, municipality_name, index) %>%
  arrange(road_reference) %>%
  flextable() %>%
  set_header_labels(name = "Trafikkregistreringspunkt",
                    road_reference = "Vegreferanse"
                    #municipality_name = "Kommune",
                    ) %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "all") %>%
  font(fontname = "Lucida Sans Unicode", part = "all") %>%
  bg(bg = "#ED9300", part = "header") %>%
  border_remove() %>%
  hline_top(part = "header", border = borderline) %>%
  hline_bottom(part = "all", border = borderline) %>%
  colformat_num(j = 3:9, na_str = "") %>% 
  autofit() %>%
  height_all(height = .2) %>%
  padding(padding.top = .3,
          padding.bottom = .3) %>%
  set_caption("Daglig endring i trafikkmengde ved utvalgte trafikkregistreringspunkter, sammenlignet mellom uke 10 og 11 i 2020.")
```

