---
title: Daglig trafikkutvikling i de største byene
output: 
  word_document:
    reference_docx: svv_notatmal.docx
    toc: true
    toc_depth: 2
    fig_caption: true
    fig_width: 7
---

```{r setup, include = FALSE, echo = FALSE, warning=FALSE, message=FALSE}
# Packages are loaded through sourcing rmd_setup.R
source("rmd_setup.R")

# Traffic Data API calls to get points metadata and aadt
source("get_from_trafficdata_api.R")

# Points used in each city
cities_points_start <- read.csv2("data_points_raw/cities_points.csv") %>% 
  dplyr::filter(city_area_name %in% c("Bergen",
                                      "Nord-Jæren",
                                      "Oslo og Akershus",
                                      "Trondheim",
                                      "Tromsø"),
                !is.na(trp_id)) %>% 
  dplyr::distinct(trp_id, .keep_all = TRUE) %>% 
  dplyr::select(city_area_name, trp_id) %>% 
  # Remove unusable trps
  dplyr::filter(!(trp_id %in% c("65625V41945",
                                "21801V72158",
                                "81008V41567",
                                "14772V41375",
                                "20570V72811",
                                "17949V320695",
                                "75341V41863")))

additional_trps <- 
  data.frame(city_area_name = 
               c(rep("Trondheim", times = 13),
                 rep("Nord-Jæren", times = 34)),
             trp_id = c(
                                  # Trondheim
                                  "04211V1677432",
                                  "94210V2411536",
                                  "78492V2394249",
                                  "44660V72811",
                                  "75341V41863",
                                  "17961V72812",
                                  "77022V72359",
                                  "36935V72359",
                                  "06970V72811",
                                  "01676V41944",
                                  "60797V2801059",
                                  "66126V3112188",
                                  "25280V41723",
                                  # Nord-Jæren
                                  "93189V320582",
                                  "52780V320689",
                                  "13715V2721330",
                                  "14570V320273",
                                  "50749V319525",
                                  "11531V320190",
                                  "71535V319524",
                                  "50741V1727509",
                                  "41451V320581",
                                  "64211V2520554",
                                  "55507V319881",
                                  "33926V2721315",
                                  "12478V320582",
                                  "88125V320152",
                                  "33902V320184",
                                  "84064V320581",
                                  "08952V320223",
                                  "81631V1727485",
                                  "59675V319722",
                                  "58562V320296",
                                  "03819V320689",
                                  "45342V320223",
                                  "44083V319868",
                                  "35382V1727514",
                                  "24330V320678",
                                  "36178V320198",
                                  "92102V319885",
                                  "32842V319521",
                                  "61487V319872",
                                  "00462V320124",
                                  "48362V320684",
                                  "89794V320138",
                                  "05658V320707",
                                  "57836V319878"
                                  ))

cities_points <- bind_rows(cities_points_start, additional_trps)

# All points from Traffic Data API
points <- get_points() %>%
  dplyr::select(trp_id, name, road_reference, municipality_name,
                lat, lon) %>%
  dplyr::distinct(trp_id, .keep_all = T)

# Adding metadata to trps
trps <- dplyr::left_join(cities_points, points) %>%
  dplyr::filter(!is.na(name)) %>% 
  dplyr::filter(!stringr::str_detect(road_reference, "KD"))

# Days we want
week_2019_from <- "2019-03-11T00:00:00+01:00"
week_2019_to <- "2019-03-18T00:00:00+01:00"

week_2020_from <- "2020-03-02T00:00:00+01:00"
week_2020_to <- "2020-03-15T00:00:00+01:00"

ukedager <- c("Mandag",
              "Tirsdag",
              "Onsdag",
              "Torsdag",
              "Fredag",
              "Lørdag",
              "Søndag")

norske_ukedager <- data.frame(weekday = c(1, 2, 3, 4, 5, 6, 7),
                              ukedag = ordered(ukedager,
                                               levels = ukedager))

# Fetch daily traffic from API
dt_2019 <- get_dt_for_trp_list(trps$trp_id,
                        week_2019_from,
                        week_2019_to)


dt_2020 <- get_dt_for_trp_list(trps$trp_id,
                               week_2020_from,
                               week_2020_to)


dt <- bind_rows(dt_2019, dt_2020) %>%
  select(-point_name) %>%
  mutate(year = lubridate::year(from),
         weekno = lubridate::isoweek(from),
         weekday = lubridate::wday(from,
                                   week_start = getOption("lubridate.week.start", 1))) %>%
  select(-from) %>% 
  filter(coverage > 99)


dt_2020_10 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 10) %>% 
  select(point_id, total_volume, weekno, weekday)

dt_2019_11 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 11) %>% 
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("21768V805002",
                           "41331V443662",
                           "71258V805748",
                           "87138V755378")))

dt_2020_11 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 11) %>% 
  select(point_id, total_volume, weekno, weekday)

# Trp index
# Compare this week to 2020 week 10  
trp_dt_2020_10_11 <- inner_join(dt_2020_10, dt_2020_11,
                            by = c("point_id", "weekday"),
                            suffix = c("_10", "_11")) %>% 
  mutate(index = round((total_volume_11 / total_volume_10 - 1) * 100, digits = 1)) %>% 
  left_join(norske_ukedager) %>% 
  select(point_id, ukedag, index) %>% 
  left_join(points, by = c("point_id" = "trp_id")) %>% 
  left_join(cities_points, by = c("point_id" = "trp_id")) %>% 
  select(ukedag, name, road_reference, city_area_name, index)

write.csv2(trp_dt_2020_10_11,
           file = "daglig_endring_punkter_2020_uke10-11.csv",
           row.names = F)

# Compare this week to same week 2019
trp_dt_201911_202011 <- inner_join(dt_2019_11, dt_2020_11,
                            by = c("point_id", "weekday"),
                            suffix = c("_b", "_c")) %>% 
  mutate(index = round((total_volume_c / total_volume_b - 1) * 100, digits = 1)) %>% 
  left_join(norske_ukedager) %>% 
  select(point_id, ukedag, index) %>% 
  left_join(points, by = c("point_id" = "trp_id")) %>% 
  left_join(cities_points, by = c("point_id" = "trp_id")) %>% 
  select(ukedag, name, road_reference, city_area_name, index)

write.csv2(trp_dt_201911_202011,
           file = "daglig_endring_punkter_2019_uke11-2020_uke11.csv",
           row.names = F)


# City index
# Compare this week to 2020 week 10
city_dt_2020_10_11 <- inner_join(dt_2020_10, dt_2020_11,
                            by = c("point_id", "weekday"),
                            suffix = c("_10", "_11")) %>% 
  left_join(cities_points, by = c("point_id" = "trp_id")) %>% 
  group_by(weekday, city_area_name) %>% 
  summarise(city_volume_10 = sum(total_volume_10),
            city_volume_11 = sum(total_volume_11),
            no_trp = n()
            ) %>% 
  mutate(index = round((city_volume_11 / city_volume_10 - 1) * 100, digits = 1)) %>% 
  left_join(norske_ukedager) %>% 
  select(city_area_name, ukedag, no_trp, index)

# Compare this week to same week 2019
city_dt_201911_202011 <- inner_join(dt_2019_11, dt_2020_11,
                            by = c("point_id", "weekday"),
                            suffix = c("_b", "_c")) %>% 
  left_join(cities_points, by = c("point_id" = "trp_id")) %>% 
  group_by(weekday, city_area_name) %>% 
  summarise(city_volume_b = sum(total_volume_b),
            city_volume_c = sum(total_volume_c),
            no_trp = n()
            ) %>% 
  mutate(index = round((city_volume_c / city_volume_b - 1) * 100, digits = 1)) %>% 
  left_join(norske_ukedager) %>% 
  select(city_area_name, ukedag, no_trp, index)

# city_dt_2020_week_10 <- dt %>% 
#   filter(year == 2020) %>%
#   select(-year) %>% 
#   left_join(cities_points, by = c("point_id" = "trp_id")) %>% 
#   group_by(weekno, weekday, city_area_name) %>% 
#   summarise(city_volume = sum(total_volume),
#             no_trp = n()
#             ) %>% 
#   pivot_wider(id_cols = c(city_area_name, weekday),
#               names_from = weekno,
#               values_from = city_volume,
#               names_prefix = "week_",
#               values_fill = list(city_volume = NA)) %>%
#   mutate(index = round((week_11 / week_10 - 1) * 100, digits = 1)) %>% 
#   left_join(norske_ukedager) %>% 
#   select(city_area_name, ukedag, index)


# TODO: compare this week to same week 2019

```

# Bakgrunn

Datagrunnlaget for beregningene hentes fra trafikkregistreringspunktene som inngår i byindeksene. Det vil gi et representativ utvalg for å kunne beregne trafikkutviklingen. Det gjøres en sammenligning av døgntrafikken, ukedag mot ukedag. Mandag sammenlignes med mandag osv.  

For å få et best mulig bilde av trafikkutviklingen gjøres to sammenligninger:

* Døgntrafikken sammenlignes med tilsvarende døgntrafikk i uke 10 i 2020
* Døgntrafikken sammenlignes med tilsvarende døgntrafikk i samme uke i 2019

Oppdatert rapport vil være tilgjengelig kl. 10 hver arbeidsdag.

Alle data er hentet fra [trafikkdata.no](https://www.trafikkdata.no/). Vi tar forbehold om feil i datagrunnlaget. Enkelte trafikkregistreringspunkter er utelatt på grunn av feil på utstyr eller at de ligger på veier som er påvirket av vegarbeid o.l. Datagrunnlaget inkluderer likevel mange nok punkter til å få fram en generell trend i trafikkutviklingen.

Været vil enkelte dager kunne påvirke trafikkmengden. For eksempel vil det ved dårlig føre, som ved stort snøfall eller underkjølt regn, bli redusert framkommelighet og dette fører til mindre trafikk enn normalt.


# Samlet endring i byene
```{r plot_city_2020, fig.width=8, fig.height=8}
city_dt_2020_10_11 %>%
  ggplot2::ggplot(aes(ukedag, index)) +
  geom_bar(aes(fill = index > 0), stat = "identity",
           color = "#000000", 
           alpha = 0.6) +
  scale_fill_manual(guide = FALSE, breaks = c(TRUE, FALSE), 
                    values = c("#ed1c2e", "#58b02c")) +
  geom_hline(yintercept = 0, color = "#000000") +
  facet_grid(city_area_name ~., switch = "y") +
  scale_y_continuous(position = "right") +
  xlab("") +
  ylab("Endring i trafikkmengde (%)\n") +
  ggtitle(label = "Daglig endring i trafikkmengde",
          subtitle = "Fra uke 10 til uke 11 i 2020") +
  theme(strip.text.y = element_text(angle = 180),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank()) +
  labs(caption = "Data: Statens vegvesen")
```

```{r plot_city_2019, fig.width=8, fig.height=8}
city_dt_201911_202011 %>%
  ggplot2::ggplot(aes(ukedag, index)) +
  geom_bar(aes(fill = index > 0), stat = "identity",
           color = "#000000", 
           alpha = 0.6) +
  scale_fill_manual(guide = FALSE, breaks = c(TRUE, FALSE), 
                    values = c("#ed1c2e", "#58b02c")) +
  geom_hline(yintercept = 0, color = "#000000") +
  facet_grid(city_area_name ~., switch = "y") +
  scale_y_continuous(position = "right") +
  xlab("") +
  ylab("Endring i trafikkmengde (%)\n") +
  ggtitle(label = "Daglig endring i trafikkmengde",
          subtitle = "Fra uke 11 2019 til uke 11 i 2020") +
  theme(strip.text.y = element_text(angle = 180),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank()) +
  labs(caption = "Data: Statens vegvesen")
```

```{r table_city}
city_dt_2020_10_11 %>%
  ungroup() %>% 
  select(-weekday, -no_trp) %>%
  pivot_wider(names_from = ukedag,
              values_from = index) %>% 
  flextable() %>%
  set_header_labels(city_area_name = "Byområde") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "all") %>%
  font(fontname = "Lucida Sans Unicode", part = "all") %>%
  bg(bg = "#ED9300", part = "header") %>%
  border_remove() %>%
  hline_top(part = "header", border = borderline) %>%
  hline_bottom(part = "all", border = borderline) %>%
  colformat_num(j = 3, na_str = "", digits = 1) %>% 
  autofit() %>%
  height_all(height = .2) %>%
  padding(padding.top = .3,
          padding.bottom = .3) %>%
  set_caption("Prosentvis endring i trafikkmengde fra uke 10 til uke 11 i 2020.")
```

I tabellen over er endringen i trafikkmengden oppgitt i prosent, sammenlignet med uke 10 som utgangspunkt. Det vil si at trafikken har gått ned fra uke 10 til uke 11, når prosentverdien er negativ. Vi ser den samme tendensen i alle byområdene. Data baserer seg på trafikken registrert i følgende antall trafikkregistreringspunkt: Bergen 45, Nord-Jæren 48, Oslo og Akershus 76 og Trondheim 18.


```{r table_city_2019}
city_dt_201911_202011 %>%
  ungroup() %>% 
  select(-weekday, -no_trp) %>%
  pivot_wider(names_from = ukedag,
              values_from = index) %>% 
  flextable() %>%
  set_header_labels(city_area_name = "Byområde") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "all") %>%
  font(fontname = "Lucida Sans Unicode", part = "all") %>%
  bg(bg = "#ED9300", part = "header") %>%
  border_remove() %>%
  hline_top(part = "header", border = borderline) %>%
  hline_bottom(part = "all", border = borderline) %>%
  colformat_num(j = 3, na_str = "", digits = 1) %>% 
  autofit() %>%
  height_all(height = .2) %>%
  padding(padding.top = .3,
          padding.bottom = .3) %>%
  set_caption("Prosentvis endring i trafikkmengde fra uke 11 2019 til uke 11 2020.")
```

I tabellen over er endringen i trafikkmengden oppgitt i prosent, sammenlignet med uke 11 i 2019 som utgangspunkt. Det vil si at trafikken har gått ned fra år 2019 til samme ukedag i 2020, når prosentverdien er negativ. Data baserer seg på trafikken registrert i følgende antall trafikkregistreringspunkt: Bergen 40, Nord-Jæren 44, Oslo og Akershus 65 og Trondheim 14.

Vi ser den samme tendensen i alle byområdene, med unntak av onsdagen. [Onsdag 13. mars 2019 var det snøfall og underkjølt regn i Oslo og Akershus](https://www.yr.no/nb/historikk/graf/1-72837/Norge/Oslo/Oslo/Oslo?q=2019-03-13). Dette er nok forklaringen til at trafikken den dagen var mindre enn normalt, og at tilsvarende onsdag i 2020 hadde mer trafikk i sammenligningen.


```{r point_graph, fig.width=8, fig.height=12}
# trp_dt_2020_week_10 %>%
#   filter(city_area_name == "Trondheim") %>% 
#   mutate(name_road = paste0(name, "\n ", road_reference)) %>% 
#   ggplot2::ggplot(aes(ukedag, index)) +
#   geom_bar(aes(fill = index < 0), stat = "identity",
#            color = "#000000", 
#            alpha = 0.6) +
#   scale_fill_manual(guide = FALSE, breaks = c(TRUE, FALSE), 
#                     values = c("#58b02c", "#ed1c2e")) +
#   geom_hline(yintercept = 0, color = "#000000") +
#   facet_grid(name_road ~., switch = "y") +
#   scale_y_continuous(position = "right") +
#   xlab("") +
#   ylab("Endring i trafikkmengde (%)\n") +
#   ggtitle(label = "Daglig endring i trafikkmengde",
#           subtitle = "Fra uke 10 2020 til uke 11 2020") +
#   theme(strip.text.y = element_text(angle = 180),
#         panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_blank(),
#         strip.background = element_blank()) +
#   labs(caption = "Data: Statens vegvesen")
```





```{r table}
# trp_dt_2020_week_10 %>%
#   filter(city_area_name == "Trondheim") %>% 
#   pivot_wider(names_from = ukedag,
#               values_from = index) %>% 
#   select(-city_area_name) %>% 
#   #select(name, road_reference, municipality_name, index) %>%
#   arrange(road_reference) %>%
#   flextable() %>%
#   set_header_labels(name = "Trafikkregistreringspunkt",
#                     road_reference = "Vegreferanse"
#                     #municipality_name = "Kommune",
#                     ) %>%
#   bold(part = "header") %>%
#   fontsize(size = 10, part = "all") %>%
#   font(fontname = "Lucida Sans Unicode", part = "all") %>%
#   bg(bg = "#ED9300", part = "header") %>%
#   border_remove() %>%
#   hline_top(part = "header", border = borderline) %>%
#   hline_bottom(part = "all", border = borderline) %>%
#   colformat_num(j = 3:9, na_str = "") %>% 
#   autofit() %>%
#   height_all(height = .2) %>%
#   padding(padding.top = .3,
#           padding.bottom = .3) %>%
#   set_caption("Daglig endring i trafikkmengde ved utvalgte trafikkregistreringspunkter, sammenlignet mellom uke 10 og 11 i 2020.")
```

