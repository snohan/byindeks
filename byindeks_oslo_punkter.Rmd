---
title: "Ny byindeks for Oslo og Akershus"
output: html_notebook
---

```{r library, include = FALSE}
library(tidyverse)
library(httr)
library(jsonlite)
library(leaflet)
library(htmlwidgets)
library(knitr)
library(sf)
library(mapview)
library(flextable)
source("funksjoner_hent_nvdb_info.R")
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      error = FALSE, cache = TRUE)
```

```{r adt, include = FALSE}
# TODO: ÅDT (med dekingsgrad) 2018 fra TD-API.
# Leser inn ÅDT (må hentes fra NVDB-API eller trafikkdata-API på sikt)
# adt <- read.csv2("adt_2017_nortraf.csv") %>% 
#   filter(Felt == "R0") %>% 
#   mutate(Stasjonnr = as.character(Tellepunkt),
#          ADT = round(ADT, digits = -2)) %>% 
#  select(Stasjonnr, ADT)
```

Tabell og kart over byindekspunktene. TRS står for trafikkregistreringsstasjon. 

Dekningsgrad er oppgitt som prosentvis andel dager registrert i året, for 2018
gjelder tall til og med august.

```{r table}
indekspunktene_oslo %>% 
  dplyr::select(name, road_reference) %>% 
  dplyr::arrange(road_reference) %>% 
  flextable::flextable() %>% 
  flextable::set_header_labels(name = "Navn",
                               road_reference = "Vegreferanse") %>% 
  flextable::bold(part = "header") %>% 
  flextable::fontsize(size = 9, part = "all") %>% 
  flextable::font(fontname = "Lucida Sans Unicode", part = "all") %>% 
  flextable::bg(bg = "#ED9300", part = "header") %>% 
  flextable::align(part = "all") %>% 
  flextable::autofit() %>% 
  flextable::height_all(height = .2) %>% 
  flextable::padding(padding.top = .3,
                     padding.bottom = .3)
```

```{r mapcode, include=FALSE}
#pal <- colorFactor(c("navy", "red"), domain = c("TRS", "Bom"))

map.oslo <- indekspunktene_oslo %>% 
  leaflet(width = "100%", 
          options = leafletOptions(minZoom = 0, maxZoom = 18)) %>% 
  addProviderTiles(providers$Esri.WorldStreetMap) %>% 
  addCircleMarkers(
    radius = 6,
    weight = 3,
    opacity = 0.6,
    fill = F
  ) #%>% 
  #addLabelOnlyMarkers(label = ~Veg,
  #                    labelOptions = 
  #                      labelOptions(noHide = T, 
  #                                   direction = 'top', 
  #                                   textOnly = T,
  #                                   offset = c(0, 7)))
```


```{r, echo=FALSE}
map.oslo
```

```{r, warning=FALSE, echo=FALSE, include=FALSE}
mapshot(map.trd, file = "byindeks_trondheim.png")
```


```{r, warning=FALSE, echo=FALSE, include=FALSE}
map.trd_sentrum <- kommunepunkter_trondheim %>% 
  filter(Byindeks == "Ja") %>% 
  filter(!(Stasjonnr %in% c("1600213", "1600209", "1602306",
                            "72", "58", "52",
                            "53", "51", "85", "86", "74",
                            "1603001", "1603002", "1603003",
                            "1603004", "1603005",
                            "1600097"))) %>% 
  leaflet(width = "100%", 
          options = leafletOptions(minZoom = 0, maxZoom = 18)) %>% 
  addProviderTiles(providers$Esri.WorldStreetMap) %>% 
  addCircleMarkers(
    radius = ~ifelse(Byindeks == "Ja", 6, 3),
    color = ~pal(Type),
    weight = 3,
    opacity = 0.6,
    fill = F
  ) %>% 
  addLabelOnlyMarkers(label = ~Veg,
                      labelOptions = 
                        labelOptions(noHide = T, 
                                     direction = 'top', 
                                     textOnly = T,
                                     offset = c(0, 7))) %>% 
  addLegend("bottomright", pal = pal, values = ~Type,
    title = "Type",
    opacity = 1
  )
```

```{r, echo=FALSE}
#map.trd_sentrum
```


```{r, warning=FALSE, echo=FALSE, include=FALSE}
mapshot(map.trd_sentrum, file = "byindeks_trondheim_s.png")
```
