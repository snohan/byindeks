---
title: "Representativitet i byindeks"
format: 
  html:
    css: svv.css
    number-sections: true
    toc: true
    toc-location: left
    toc-title: "Innhold"
    toc-expand: true
    toc-depth: 2
    df-print: paged
    self-contained: true
crossref:
  fig-title: Figur
  tbl-title: Tabell
  title-delim: .
  fig-prefix: figur
  tbl-prefix: tabell
editor: source
knitr: 
  opts_chunk: 
    echo: false
---


```{r}
#| label: setup
#| include: false
#| echo: false
#| warning: false
#| message: false
  
base::Sys.setlocale(locale = "nb.utf8")
svv_background_color <- "#F5F5F5"

library(tidyverse)
library(patchwork)
library(flextable)
library(vcd)
library(sf)
#library(sfnetworks)
library(igraph)
library(tidygraph)
library(htmltools)
library(leaflet)
library(RColorBrewer)
library(leaflet)

source("H:/Programmering/R/byindeks/leaflet_nvdb_map_setup.R")
source("H:/Programmering/R/byindeks/traffic_link_functions.R")
source("H:/Programmering/R/byindeks/index_report_functions.R")

flextable::set_flextable_defaults(
  #font.size = 8,
  #padding.bottom = .2,
  #padding.top = .4,
  decimal.mark = ",",
  big.mark = " ",
  na_str = ""
)
```

```{r}
#| label: data


# Misc
this_date <- lubridate::today()
this_date_string <- 
  base::paste0(
    lubridate::mday(this_date), 
    ". ", 
    lubridate::month(this_date, label = TRUE, abbr = FALSE), 
    " ", 
    lubridate::year(this_date)
  )


# RTM
rtm_trd <- readr::read_rds("representativity/rtm_20_22_trondheim.rds")
rtm_trd_index <- readr::read_rds("representativity/rtm_20_22_trondheim_index.rds")
rtm_random_samples <- readr::read_rds("representativity/rtm_random_samples.rds")

random_samples_stats <-
  rtm_random_samples |> 
  dplyr::summarise(
    n = n(),
    mean_index_p = mean(tw_area_index_p),
    median_index_p = median(tw_area_index_p),
    min_index_p = min(tw_area_index_p),
    max_index_p = max(tw_area_index_p),
    mean_sd = mean(weighted_sd_p),
    sd = sd(tw_area_index_p),
    sd_test = sqrt((1/999) * sum((tw_area_index_p - mean(tw_area_index_p))^2)),
    ci_lower = mean_index_p - 1.96 * sd,
    ci_upper = mean_index_p + 1.96 * sd
  )

rtm_random_samples_ci <- 
  paste0(
    "(", 
    base::sprintf("%.1f", random_samples_stats$ci_lower) |> stringr::str_replace("\\.",","),
    ", ", 
    base::sprintf("%.1f", random_samples_stats$ci_upper) |> stringr::str_replace("\\.",","),
    ")"
  )


# Links and index correlation
links_and_index <- readr::read_rds("representativity/links_and_index.rds")

```

# Innledning
Dette dokumentet er et supplement til notatet [Forbedret byindeks](https://vegvesen.sharepoint.com/:w:/r/sites/arb-Trafikkdataogtrafikkutviklingiby/Delte%20dokumenter/General/Arbeidsgruppa/Oppgaver/Representativitet%20i%20byindeks/Representativitet%20i%20byindeks.docx?d=w8fb786036594485bbb5d282a07b9db78&csf=1&web=1&e=p58ZHf) og inneholder detaljer om de utforskende dataanalysene som ligger til grunn for vurderingene som er beskrevet der.

Sist oppdatert `r this_date_string`. 

Kontaktperson: </br>
Snorre Hansen, </br>
Statens vegvesen </br>
Divisjon for Transport og samfunn, </br>
Avdeling for Transportutvikling, </br>
Seksjon for Veg- og transportteknologi


## Bakgrunn
Utgangspunktet for indeksmetodikken er å se på vegnettet som en populasjon som det gjøres et utvalg fra. Individene i populasjonen er trafikklenker, som er vegstrekninger fra kryss til kryss som har homogen trafikkmengde gitt en tidsoppløsning på minst et døgn.

Arbeidet med representativitet er gjort før det er gjort en nærmere analyse på selve beregningsmetoden til byindeksen. Representativitet og beregningsmetode henger tett sammen, men det antas her at metodikken for beregning av byindeks er som et vektet gjennomsnitt av trafikklenkenes endring i trafikkarbeid, der trafikkarbeidet er vektene.


{{< include index_representativeness_known_pop.qmd >}}


# Forklaringsvariabler
I Trafikkdatasystemet er det generert opp trafikklenker fra det digitale vegnettet i NVDB, som så er beriket med flere aktuelle variabler:

- vegkategori
- lenkelengde
- trafikkmengde (ÅDT)
- trafikkarbeid
- minste og største antall kjørefelt
- laveste og høyeste fartsgrense
- funksjonsklasse
- funksjonell vegklasse

I tillegg er det hentet inn datasett fra SSB i form av polygoner med informasjon om:

- tettsteder
- antall næringsvirksomheter
- antall ansatte
- antall innbyggere

Verdiene for disse størrelsene er tilknyttet de trafikklenkene som overlapper med polygonene. 

Trafikklenkene er lett tilgjengelige via API og eksportfunksjonalitet i Trafikkdatasystemet og holdes kontinuerlig oppdatert.

De regionale transportmodellene har egenskaper på sine trafikklenker som kunne være aktuelle variabler i indekssammenheng:

- fordeling av reiselengder
- fordeling av reisehensikt
- andel turer

I byindekssammenheng er det kun relevant å se på reiser utført av bilfører. Verdiene finnes i hver enkelt delområdemodell, men det er ikke et felles sted å hente disse variablene fra, noe som gjør de mindre tilgjengelig og dermed uaktuelle for videre bruk i byindekssammenheng.

For å finne ut om noen av de tilgjengelige variablene kan brukes til å forklare størrelsen og variasjonen til trafikklenkeindeksene, er det gjennomført en korrelasjonanalyse. For kategoriske forklaringsvariabler kan vi visuelt vurdere variasjonen ved hjelp av boksplott, mens for numeriske ser vi på Spearmans korrelasjonskoeffisient (som tar høyde for eventuelle ikke-lineære sammenhenger).

Vi finner at ingen av de tilgjengelige variablene har noen sterk korrelasjon med trafikklenkeindeksen. For funksjonsklasse finner vi i enkelte måneder en svak korrelasjon, se @fig-correlation_brg og @fig-correlation_nj. Korrelasjon mellom en kontinuerlig variabel (indeks) og en kategorisk variabel (funksjonsklasse) vises tydelig i et boksplott dersom det er lite overlapp mellom boksene.


```{r}
#| label: fig-correlation_brg
#| fig-cap: "Fordeling av trafikklenkeindekser per funksjonsklasse, Bergensområdet. Utliggere er ikke tatt med i visningen."

links_and_index |>
  dplyr::filter(
    city == "Bergen",
    function_class != "E"
  ) |>
  ggplot(aes(function_class, index)) +
  geom_boxplot(
    outliers = FALSE
  ) +
  facet_wrap(~month) +
  theme_light() +
  theme(
    panel.grid.minor.x = element_blank(),
    plot.caption =
      element_text(
        face = "italic",
        size = 8,
        lineheight = 1.5,
        vjust = 0
      ),
    plot.background = element_rect(fill = svv_background_color),
    panel.background = element_rect(fill = svv_background_color)
  ) +
  labs(
    x = "Funksjonsklasse", y = "Indeks (%-poeng)"
  ) +
  ggtitle(
    "Trafikklenkeindeks per funksjonsklasse, Bergensområdet"
  )
```

```{r}
#| label: fig-correlation_nj
#| fig-cap: "Fordeling av trafikklenkeindekser per funksjonsklasse, Nord-Jæren. Utliggere er ikke tatt med i visningen."

links_and_index |>
  dplyr::filter(
    city == "Nord-Jæren",
    function_class != "E"
  ) |>
  ggplot(aes(function_class, index)) +
  geom_boxplot(
    outliers = FALSE
  ) +
  facet_wrap(~month) +
  theme_light() +
  theme(
    panel.grid.minor.x = element_blank(),
    plot.caption =
      element_text(
        face = "italic",
        size = 8,
        lineheight = 1.5,
        vjust = 0
      ),
    plot.background = element_rect(fill = svv_background_color),
    panel.background = element_rect(fill = svv_background_color)
  ) +
  labs(
    x = "Funksjonsklasse", y = "Indeks (%-poeng)"
  ) +
  ggtitle(
    "Trafikklenkeindeks per funksjonsklasse, Nord-Jæren"
  )
```

En kategorisk variabel som er korrelert med vår interessevariabel (indeks) kan benyttes til etterstratifisering for å korrigere for eventuelle skjevheter i utvalget. Selv om korrelasjonen til tider er ganske svak vil estimatet for områdeindeksen treffe nærmere sannheten med en etterstratifisering. Den estimerte usikkerheten kan også bli noe lavere.


# Mål for representativitet
Føyningsmål ("goodness of fit") fra for eksempel Kolmogorov-Smirnov-testen gir ett tall som er den største avstanden mellom to fordelinger. Et avstandsmål som summerer opp "hele" avviket mellom to fordelinger er å foretrekke.


## Fordeling av trafikklenker
Trafikklenkenes trafikkarbeid kan fordeles etter funksjonsklasse. Ved å sammenligne utvalgets fordeling med populasjonens fordeling, vil graden av likhet være et mål på representativitet. Her er det sett på to ulike måter å beregne forskjellen på. Den ene måten kalles "total variation distance" (TVD) og beregnes ved først å finne den absolutte forskjellen mellom utvalget $S$ og populasjonen $P$ sine andeler trafikkarbeid for hver funksjonsklasse $k$, for så å summere disse for alle funksjonsklassene og til slutt dele på to. Matematisk kan dette skrives slik:

$$
\delta(P, S) = \frac{1}{2} \sum_k \left| P(k) - S(k) \right|.
$$ {#eq-tvd}

Den andre metoden er kalt Hellingers distanse og er definert slik: 

$$
H(P, S) = \frac{1}{\sqrt{2}} \sqrt{\sum_k \left( \sqrt{P(k)} - \sqrt{S(k)} \right)^2}.
$$ {#eq-hellinger}

Felles for begge måtene er at om de to fordelingene er helt like, så blir verdien null. TVD er den enkleste og mest intuitive, så den vil bli foretrukket.


## Geografisk spredning
Ved å se på vegnettet som en sammenhengende grafstruktur, kan det beregnes grafparametre som beskriver dekningen og spredningen av trafikklenker. En utfordring med slike metrikker er at de må ta hensyn til at vegnettet endrer seg over tid.


### Gjennomsnittlig avstand til byindekspunkt
Et relevant mål er den gjennomsnittlige korteste avstanden fra trafikklenkene som ikke er med i utvalget $(P-S)$ til de som er utvalgt $(S)$. Dette sier noe om hvor spredt punktene ligger. Denne avstanden er definert som

$$
\bar{d}(P, S) = \frac{1}{P - S} \sum_{p \in P - S} \min_{s \in S} d(p, s),
$$ {#eq-closeness_representation}

hvor $d(p, s)$ er den korteste vegen fra trafikklenke $p$ til trafikklenke $s$. For å beregne dette er det nødvendig å linjetransformere grafen slik at trafikklenker blir representert som noder. I grafsammenheng er avstander kun målt i antall lenker som må traverseres for å komme fra en node til en annen. Det er en forutsetning at vegnettet er sammenhengende for at denne verdien skal kunne beregnes.

Med tanke på representativitet er det ingen naturlig grenseverdi for denne størrelsen, men den kan sammenlignes over tid. Det beste resultatet gitt $n$ punkt kan formuleres som et optimeringsproblem, som vi kan sammenligne det faktiske utvalget med. Helt generelt kan det være litt kunstig å sette et fast antall punkt, men dette kan argumenteres ut fra økonomiske hensyn. Det er således mulig å beregne hvor mye bedre representativiteten blir dersom antallet punkt øker, og tilsvarende hvor mye verre det blir om antallet minker. Metoden kan også brukes til å simulere utvalg, og peke ut den beste posisjonen til punkt $n+1$. Imidlertid er det ikke opplagt hvordan en slik beregning kan ta hensyn til fordeling av trafikkarbeid i funksjonsklasser.


### Andel utvalgte trafikklenker inkludert nærmeste nabolenker
Et annet potensielt mål for representativitet i form av en metrikk på en graf, er andel utvalgte trafikklenker inkludert nærmeste nabolenker. Dette impliserer at det er en romlig korrelasjon mellom nabolenker, men den er ikke påviselig. Derfor anses ikke denne metrikken som aktuell.


## Minste antall punkt
Tar hensyn til at populasjonens størrelse er kjent.

GJENSTÅENDE ARBEID


