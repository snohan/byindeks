---
output: 
  word_document:
    reference_docx: svv_notatmal.docx
    toc: TRUE
    toc_depth: 2
---

```{r library, include = FALSE}
library(tidyverse)
library(ggmap)
library(htmlwidgets)
library(leaflet)
library(mapview)
library(knitr)
library(flextable)
source("api_keys.R")
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      error = FALSE, cache = TRUE)
```


```{r point_with_all_info, include = FALSE}
all_point_info <- read.csv2("indekspunktene_trondheim_2018.csv") %>% 
  arrange(Vegreferanse) %>% 
  rename(Stasjonstype = Type)
```


# Bakgrunn

Bymiljøavtalen som ble inngått i 2016 mellom Trondheim kommune, Sør-Trøndelag fylkeskommune og Staten gjaldt for perioden 2016-2023. Målet med avtalen er at veksten i persontransporten skal tas med kollektivtrafikk, sykling og gåing («nullvekstmålet»). Området avtalen gjaldt for var Trondheim kommune.

Byindeksen er en av målindikatorene og estimerer endringen i biltrafikk for "lette" biler. Byindeksen er en trafikkindeks for vegtrafikk basert på registreringer fra faste trafikkregistreringspunkter fordelt på riksveger, fylkesveger og kommunale veger. Trafikkindeksen skal gi et representativt bilde av trafikkutviklingen i avtaleområdet. Lettere næringstransport er
tatt ut av trafikkindeksen da det er unntatt fra nullvekstmålet. Det samme gjelder for gjennomgangstrafikk.

(Bymiljøavtalen ble i 2019 erstattet av en byvekstavtale for Trondheimsområdet som gjelder for 2019-2029.)


## Kart over byindekspunktene
```{r map}
# ggmap - begrenset til 640x640 piksler.
trondheimskart <-
  ggmap(get_map(location = c(10.42, 63.37), zoom = 11,
          maptype = "roadmap")) +
  geom_point(data = all_point_info, size = 4, stroke = .4, shape = 22,
             aes(x = lon, y = lat, 
                 fill = ADT,
                 color = Stasjonstype)) +
  scale_fill_viridis_c(name = "ÅDT") +
  scale_color_manual(values = c("Bom" = "red", "TRS" = "white")) +
  ggtitle(label = "Byindekspunkter i Trondheim", 
          subtitle = "Hele området") +
  xlab("") +
  ylab("") +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

trondheimskart

# leaflet
# pal <- colorFactor(c("navy", "red"), domain = c("TRS", "Bom"))
# 
# trondheimskart <- all_point_info %>% 
#   leaflet(width = "100%",
#           options = leafletOptions(minZoom = 0, maxZoom = 18)) %>% 
#   addProviderTiles(providers$Esri.WorldStreetMap) %>% 
#   addCircleMarkers(
#     color = ~pal(Type),
#     weight = 3,
#     opacity = 0.6,
#     fill = F
#   ) %>% 
#   addLabelOnlyMarkers(label = ~Veg,
#                       labelOptions = 
#                         labelOptions(noHide = T, 
#                                      direction = 'top', 
#                                      textOnly = T,
#                                      offset = c(0, 7))) %>% 
#   addLegend("bottomright", pal = pal, values = ~Type,
#     title = "Type",
#     opacity = 1
#   )
# 
# mapshot(trondheimskart, file = "trondheimskart.png")

```


```{r map2}
trondheimskart_sentrum <-
  ggmap(get_map(location = c(10.42, 63.41), zoom = 12,
          maptype = "roadmap")) +
  geom_point(data = all_point_info, size = 4, stroke = .4, shape = 22,
             aes(x = lon, y = lat, 
                 fill = ADT,
                 color = Stasjonstype)) +
  scale_fill_viridis_c(name = "ÅDT") +
  scale_color_manual(values = c("Bom" = "red", "TRS" = "white")) +
  ggtitle(label = "Byindekspunkter i Trondheim", 
          subtitle = "Sentrum") +
  xlab("") +
  ylab("") +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

trondheimskart_sentrum
```



## Tabell med byindekspunktene
```{r table}
all_point_info %>% 
  select(Stasjonnr, Navn, Veg, Type, ADT, Indeks) %>% 
  flextable() %>% 
  colformat_num(col_keys = "ADT", 
                big.mark = " ", digits = 0) %>%
  colformat_num(col_keys = c("Indeks"), digits = 1) %>%
  set_header_labels(ADT = "ÅDT") %>% 
  bold(part = "header") %>% 
  fontsize(size = 9, part = "all") %>% 
  font(fontname = "Lucida Sans Unicode", part = "all") %>% 
  bg(bg = "#FFC05B", part = "header") %>% 
  autofit()
# TODO: table caption?
```


# Resultater

## Tabell med byindeksen

## Graf med punktindeksene

## Kommentarer