---
output: 
  word_document:
    reference_docx: svv_notatmal.docx
    toc: TRUE
    toc_depth: 2
    fig_caption: true
---

```{r library, include = FALSE}
library(tidyverse)
library(ggmap)
library(knitr)
library(flextable)
source("api_keys.R")
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      error = FALSE, cache = TRUE)
```


```{r point_with_all_info, include = FALSE}
all_point_info <- read.csv2("indekspunktene_trondheim_2018.csv") %>% 
  arrange(Vegreferanse) %>% 
  rename(Stasjonstype = Type)
```


# Bakgrunn

Bymiljøavtalen som ble inngått i 2016 mellom Trondheim kommune, Sør-Trøndelag fylkeskommune og Staten gjaldt for perioden 2016-2023. Målet med avtalen er at veksten i persontransporten skal tas med kollektivtrafikk, sykling og gåing («nullvekstmålet»). Området avtalen gjaldt for var Trondheim kommune.

Byindeksen er en av målindikatorene og estimerer endringen i biltrafikk for "lette" biler. Byindeksen er en trafikkindeks for vegtrafikk basert på registreringer fra faste trafikkregistreringspunkter fordelt på riksveger, fylkesveger og kommunale veger. Trafikkindeksen skal gi et representativt bilde av trafikkutviklingen i avtaleområdet. Lettere næringstransport er
tatt ut av trafikkindeksen da det er unntatt fra nullvekstmålet. Det samme gjelder for gjennomgangstrafikk.

(Bymiljøavtalen ble i 2019 erstattet av en byvekstavtale for Trondheimsområdet som gjelder for 2019-2029.)


## Kart over byindekspunktene
Kartet viser plasseringen av byindekspunktene, først over hele byen og så zoomet inn på sentrum.

\newline

```{r map, fig.cap = "Alle byindekspunktene i Trondheim."}
# ggmap - begrenset til 640x640 piksler.
trondheimskart <-
  ggmap(get_map(location = c(10.42, 63.37), zoom = 11,
                maptype = "roadmap")) +
  geom_point(data = all_point_info, size = 4, stroke = .4, shape = 22,
             aes(x = lon, y = lat, 
                 fill = ADT,
                 color = Stasjonstype)) +
  scale_fill_viridis_c(name = "ÅDT") +
  scale_color_manual(values = c("Bom" = "red", "TRS" = "white")) +
  ggtitle(label = "Byindekspunkter i Trondheim", 
          subtitle = "Hele området") +
  xlab("") +
  ylab("") +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

trondheimskart
```


```{r map2, fig.cap = "Byindekspunktene i sentrum av Trondheim."}
trondheimskart_sentrum <-
  ggmap(get_map(location = c(10.42, 63.41), zoom = 12,
          maptype = "roadmap")) +
  geom_point(data = all_point_info, size = 4, stroke = .4, shape = 22,
             aes(x = lon, y = lat, 
                 fill = ADT,
                 color = Stasjonstype)) +
  scale_fill_viridis_c(name = "ÅDT") +
  scale_color_manual(values = c("Bom" = "red", "TRS" = "white")) +
  ggtitle(label = "Byindekspunkter i Trondheim", 
          subtitle = "Sentrum") +
  xlab("") +
  ylab("") +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

trondheimskart_sentrum
```



Tabellen nedenfor viser byindekspunktene og indeksen for 2018. ÅDT er fra 2017.
\newline

```{r table}
all_point_info %>% 
  select(Stasjonnr, Navn, Veg, Type, ADT, Indeks) %>% 
  flextable() %>% 
  colformat_num(col_keys = "ADT", 
                big.mark = " ", digits = 0) %>%
  colformat_num(col_keys = c("Indeks"), digits = 1) %>%
  set_header_labels(ADT = "ÅDT") %>% 
  bold(part = "header") %>% 
  fontsize(size = 9, part = "all") %>% 
  font(fontname = "Lucida Sans Unicode", part = "all") %>% 
  bg(bg = "#FFC05B", part = "header") %>% 
  autofit()
# TODO: table caption?
```


# Resultater
I figuren nedenfor er punktindeksene illustrert. Den horisontale streken viser byindeksens samlede verdi for 2018.
\newline

```{r graph, fig.cap = "Graf over punktindeksene."}
all_point_info_index <- all_point_info %>% 
  dplyr::filter(!is.na(Indeks)) %>% 
  dplyr::mutate(Navn = as.character(Navn)) %>% 
  dplyr::arrange(desc(Navn))

all_point_info_index_plot <-
  ggplot2::ggplot() +
  geom_point(data = all_point_info_index, aes(x = Navn, y = Indeks, size = ADT)) +
  geom_hline(yintercept = 0) +
  coord_flip() +
  scale_size(name = "ÅDT") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -3.2, ymax = 3.2),
            alpha = 0.1, fill = "blue")


all_point_info_index_plot
```


## Kommentarer
Blant punktindeksene skiller Tillerbrua på Fv6680 seg ut med sine 68,5 %. Dette skyldes delvis anleggsarbeid på Fv6680 i 2017, samt på Fv704 mellom Trondheim og Klæbu gjennom hele året unntatt desember. Fv704 var helt stengt i 8 uker på sommeren 2017 og 2018. Mye av trafikken gikk derfor via Fv6680 og Tillerbrua. Vi ser en tilsvarende nedgang på Torgårdsletta på Fv704 med -10,9 %. Til sammen fanger de to bomstasjonene her opp den totale trafikken mellom Trondheim og Klæbu.