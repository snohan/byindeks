---
output: 
  word_document:
    reference_docx: svv_notatmal.docx
    toc: TRUE
    toc_depth: 2
---

```{r library, include = FALSE}
library(tidyverse)
library(httr)
library(jsonlite)
library(leaflet)
library(htmlwidgets)
library(knitr)
library(sf)
library(mapview)
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      error = FALSE)
```

```{r sources, include = FALSE}
source("funksjoner_hent_nvdb_info.R")
# TODO: source("get_calls_from_trafficdata_api.R")
```


```{r points, include = FALSE}
# Fetching index traffic registration points (TRPs).
# TODO: From a manually edited CSV-file.
# TODO: Get metadata from Trafficdata-API.

# Get all TRS in the municipalities from NVDB
# Trondheim 5001
kommunenr <- "5001"

kommunenavn <- hent_kommune(kommunenr)[[1]]

kommune_trser_5001 <- 
  hent_trafikkregistreringsstasjon_for_omraade(kommunenr) %>% 
  mutate(Type = "TRS")

kommune_bomer <- 
  hent_bomstasjon_for_kommune(kommunenr) %>% 
  mutate(Type = "Bom")

# Må legge til for 52 som er borte fra API-et.
bom_52 <- data.frame(
  "Stasjonnr" = "52", 
  "Navn" = "Klett - E6, S-snitt",
  "Vegreferanse" = "5000 Ev6 hp9 m1252",
  "lat" = 63.32590,
  "lon" = 10.32702,
  "Veg" = "E6",
  "Kommune" = "Trondheim",
  "Type" = "Bom")

kommunepunkter <- bind_rows(kommune_trser_5001, kommune_bomer, bom_52)

# The points chosen for the index
byindekspunkter_valgte <- read.csv2("byindekspunkter_vedtatte.csv") %>% 
  dplyr::filter(city_area_name == "Trondheim") %>% 
  mutate(Stasjonnr = as.character(legacyNortrafMpn)) %>% 
  select(Stasjonnr)
```

```{r aadt, include = FALSE}
# TODO: Get AADT with coverage for the index TRPs.
adt <- read.csv2("adt_2017_nortraf.csv") %>% 
  filter(Felt == "R0") %>% 
  mutate(Stasjonnr = as.character(Tellepunkt),
         ADT = round(ADT, digits = -2)) %>% 
  select(Stasjonnr, ADT)
```

```{r indexresults, include = FALSE}
# Read index results from CSV-files.
indekstall <- 
  read.csv2("punktindeks_trondheim_alle_punkter_jan-des18.csv") %>% 
  mutate(trs = as.numeric(msnr),
         trs = if_else(trs > 9916000, trs - 9916000, trs)) %>% 
  select(-msnr) %>% 
  group_by(trs) %>% 
  summarise(trafikkmengde_basisaar = sum(trafikkmengde.basisaar),
            trafikkmengde_indeksaar = sum(trafikkmengde.indeksaar),
            Indeks = round((trafikkmengde_indeksaar/
                     trafikkmengde_basisaar - 1) * 100,
                     digits = 1)) %>% 
  mutate(trs = as.character(trs)) %>% 
  rename(Stasjonnr = trs) %>% 
  select(Stasjonnr, Indeks)
```

```{r point_with_all_info, include = FALSE}
# Joining tables
indekspunktene <- byindekspunkter_valgte %>% 
  left_join(kommunepunkter) %>% 
  left_join(adt) %>% 
  left_join(indekstall)
```




# Bakgrunn

Bymiljøavtalen som ble inngått i 2016 mellom Trondheim kommune, Sør-Trøndelag fylkeskommune og Staten gjaldt for perioden 2016-2023. Målet med avtalen er at veksten i persontransporten skal tas med kollektivtrafikk, sykling og gåing («nullvekstmålet»). Området avtalen gjaldt for var Trondheim kommune.

Byindeksen er en av målindikatorene og estimerer endringen i biltrafikk for "lette" biler. Byindeksen er en trafikkindeks for vegtrafikk basert på registreringer fra faste trafikkregistreringspunkter fordelt på riksveger, fylkesveger og kommunale veger. Trafikkindeksen skal gi et representativt bilde av trafikkutviklingen i avtaleområdet. Lettere næringstransport er
tatt ut av trafikkindeksen da det er unntatt fra nullvekstmålet. Det samme gjelder for gjennomgangstrafikk.

(Bymiljøavtalen ble i 2019 erstattet av en byvekstavtale for Trondheimsområdet som gjelder for 2019-2029.)


## Kart over byindekspunktene
```{r map}
#

```


## Tabell med byindekspunktene
```{r table}
indekspunktene %>% 
  select(Stasjonnr, Navn, Veg, Kommune, Type, ADT, Indeks) %>% 
  arrange(Veg) %>% 
  kable(format.args = list(big.mark = " "))
# TODO: kableExtra?
```


# Resultater

## Tabell med byindeksen

## Graf med punktindeksene

## Kommentarer