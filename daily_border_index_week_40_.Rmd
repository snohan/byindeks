---
#title: Daglig endring i trafikk ved riksgrensen
output: 
  officedown::rdocx_document:
    reference_docx: svv_template.docx
    toc: true
    toc_depth: 2
    fig_caption: true
    fig_width: 7
    tables:
      style: Table
      layout: autofit
      width: 1.0
      caption:
        style: Tabelltekst
        pre: 'Tabell'
        sep: '. '
      conditional:
        first_row: true
        first_column: false
        last_row: false
        last_column: false
        no_hband: false
        no_vband: true
    plots:
      style: Normal
      align: center
      caption:
        style: Figurtekst
        pre: 'Figur '
        sep: '. '
    lists:
      ol.style: null
      ul.style: null
---

```{r setup, include = FALSE, echo = FALSE, warning=FALSE, message=FALSE}
# Packages are loaded through sourcing rmd_setup.R
source("rmd_setup.R")

# Traffic Data API calls to get points metadata and aadt
source("get_from_trafficdata_api.R")

# Points on border crossings
border_trp_ids <- c("04904V971774",
                    "35229V971507",
                    "02535V971411",
                    "09269V971425",
                    "21405V2607269",
                    "05732V971567",
                    "76778V704564",
                    "57929V705247",
                    "94299V704696",
                    "94864V704707",
                    "00737V704646",
                    "14158V705081",
                    "69140V704643",
                    "11051V704737",
                    "66220V72824",
                    "84237V578097",
                    "50089V578151",
                    "93561V578187",
                    "99923V578123",
                    "08581V885541",
                    "35829V885266",
                    "77275V885276",
                    "01777V885181",
                    "45313V1125788",
                    "85233V930344",
                    #"13177V930320", feil på sløyfe fra 05.01.2020
                    "97351V930305",
                    "99312V930442",
                    "68101V930654",
                    "97687V930620"
                    )

# All points from Traffic Data API
points <- get_points() %>%
  dplyr::select(trp_id, name, road_reference, municipality_name,
                lat, lon) %>%
  dplyr::distinct(trp_id, .keep_all = T) %>% 
  dplyr::mutate(name = stringr::str_to_title(name, locale = "no"))

# Adding metadata to trps
border_trps <- points %>%
  dplyr::filter(trp_id %in% border_trp_ids) %>% 
  dplyr::arrange(desc(lat))


# TRP AADT ####
adt <- get_aadt_for_trp_list(border_trps$trp_id)

adt_filtered <- adt %>%
  #dplyr::filter(coverage > 20) %>%
  dplyr::group_by(trp_id) %>%
  dplyr::filter(year == max(year)) %>%
  dplyr::select(trp_id, adt)

border_trp_adt <- border_trps %>% 
  left_join(adt_filtered)


# Daily traffic ####
# Same week in 2019

# From week 40
borderdata_2019_from <- "2019-09-30T00:00:00+02:00"
borderdata_2019_to <- "2019-12-09T00:00:00+02:00"

borderdata_2020_from <- "2020-09-28T00:00:00+02:00"
borderdata_2020_to <- "2020-12-07T00:00:00+02:00"

ukedager <- c("Mandag",
              "Tirsdag",
              "Onsdag",
              "Torsdag",
              "Fredag",
              "Lørdag",
              "Søndag")

norske_ukedager <- data.frame(weekday = c(1, 2, 3, 4, 5, 6, 7),
                              ukedag = ordered(ukedager,
                                               levels = ukedager))

# Fetch daily traffic from API
border_dt_2019 <- get_dt_for_trp_list(border_trps$trp_id,
                                      borderdata_2019_from,
                                      borderdata_2019_to)

border_dt_2020 <- get_dt_for_trp_list(border_trps$trp_id,
                                      borderdata_2020_from,
                                      borderdata_2020_to)

border_dt <- bind_rows(border_dt_2019, border_dt_2020) %>%
  select(-point_name) %>%
  mutate(year = lubridate::year(from),
         weekno = lubridate::isoweek(from),
         weekday = lubridate::wday(from,
                                   week_start =
                                     getOption("lubridate.week.start", 1))) %>%
  select(-from) %>% 
  filter(coverage > 99)



# Weeks 2019 ####
border_dt_2019_40 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 40) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2019_41 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 41) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2019_42 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 42) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2019_43 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 43) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2019_44 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 44) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2019_45 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 45) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2019_46 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 46) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2019_47 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 47) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2019_48 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 48) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2019_49 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 49) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2019_50 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 50) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2019_51 <- border_dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 51) %>% 
  select(point_id, total_volume, weekno, weekday)


# ADD NEW WEEK HERE!!!



# Weeks 2020 ####
border_dt_2020_40 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 40) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2020_41 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 41) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2020_42 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 42) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2020_43 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 43) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2020_44 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 44) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2020_45 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 45) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2020_46 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 46) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2020_47 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 47) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2020_48 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 48) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2020_49 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 49) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2020_50 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 50) %>% 
  select(point_id, total_volume, weekno, weekday)

border_dt_2020_51 <- border_dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 51) %>% 
  select(point_id, total_volume, weekno, weekday)

# ADD NEW WEEK HERE!!!


# Trp index ####
calculate_trp_border_index <- function(dt_base, dt_calc) {
  trp_daily_index <- inner_join(dt_base, dt_calc,
                                by = c("point_id", "weekday"),
                                suffix = c("_b", "_c")) %>% 
    mutate(index = round((total_volume_c / total_volume_b - 1) * 100, 
                         digits = 1),
           index = dplyr::na_if(index, "Inf")) %>% 
    left_join(norske_ukedager) %>% 
    select(point_id, ukedag, index) %>% 
    left_join(points, by = c("point_id" = "trp_id")) %>% 
    left_join(adt_filtered, by = c("point_id" = "trp_id")) %>% 
    tidyr::separate(road_reference, c("road", "strekning", "meter"),
                    sep = " ") %>%    
#    mutate(road = stringr::str_split_fixed(road_reference, " ", 2)) %>% 
    select(name, road, adt, municipality_name, ukedag, index) %>% 
    arrange(factor(ukedag, levels = ukedager)) %>% 
    # TODO: sort by weekday
    tidyr::pivot_wider(names_from = ukedag,
                       values_from = index)
}


# Compare week 2020 to same week 2019 ####
border_trp_dt_40 <- calculate_trp_border_index(
  border_dt_2019_40,
  border_dt_2020_40
)

border_trp_dt_41 <- calculate_trp_border_index(
  border_dt_2019_41,
  border_dt_2020_41
)

border_trp_dt_42 <- calculate_trp_border_index(
  border_dt_2019_42,
  border_dt_2020_42
)

border_trp_dt_43 <- calculate_trp_border_index(
  border_dt_2019_43,
  border_dt_2020_43
)

border_trp_dt_44 <- calculate_trp_border_index(
  border_dt_2019_44,
  border_dt_2020_44
)

border_trp_dt_45 <- calculate_trp_border_index(
  border_dt_2019_45,
  border_dt_2020_45
)

border_trp_dt_46 <- calculate_trp_border_index(
  border_dt_2019_46,
  border_dt_2020_46
)

border_trp_dt_47 <- calculate_trp_border_index(
  border_dt_2019_47,
  border_dt_2020_47
)

border_trp_dt_48 <- calculate_trp_border_index(
  border_dt_2019_48,
  border_dt_2020_48
)

border_trp_dt_49 <- calculate_trp_border_index(
  border_dt_2019_49,
  border_dt_2020_49
)

border_trp_dt_50 <- calculate_trp_border_index(
  border_dt_2019_50,
  border_dt_2020_50
)

border_trp_dt_51 <- calculate_trp_border_index(
  border_dt_2019_51,
  border_dt_2020_51
)


# ADD NEW TRP INDEX HERE!!!



# Border index ####
calculate_border_index <- function(dt_base, dt_calc) {
  border_daily_index <- inner_join(dt_base, dt_calc,
                            by = c("point_id", "weekday"),
                            suffix = c("_b", "_c")) %>% 
  group_by(weekday) %>% 
  summarise(border_volume_b = sum(total_volume_b),
            border_volume_c = sum(total_volume_c),
            no_trp = n()
            ) %>% 
  mutate(index = round((border_volume_c / border_volume_b - 1) * 100, 
                       digits = 1)) %>% 
  left_join(norske_ukedager) %>% 
  select(ukedag, no_trp, index)
}


# Compare this week to same week 2019 ####
border_dt_40 <- calculate_border_index(
  border_dt_2019_40, 
  border_dt_2020_40) %>% 
  mutate(periode = "Uke \n 40")

border_dt_41 <- calculate_border_index(
  border_dt_2019_41, 
  border_dt_2020_41) %>% 
  mutate(periode = "Uke \n 41")

border_dt_42 <- calculate_border_index(
  border_dt_2019_42, 
  border_dt_2020_42) %>% 
  mutate(periode = "Uke \n 42")

border_dt_43 <- calculate_border_index(
  border_dt_2019_43, 
  border_dt_2020_43) %>% 
  mutate(periode = "Uke \n 43")

border_dt_44 <- calculate_border_index(
  border_dt_2019_44, 
  border_dt_2020_44) %>% 
  mutate(periode = "Uke \n 44")

border_dt_45 <- calculate_border_index(
  border_dt_2019_45, 
  border_dt_2020_45) %>% 
  mutate(periode = "Uke \n 45")

border_dt_46 <- calculate_border_index(
  border_dt_2019_46, 
  border_dt_2020_46) %>% 
  mutate(periode = "Uke \n 46")

border_dt_47 <- calculate_border_index(
  border_dt_2019_47, 
  border_dt_2020_47) %>% 
  mutate(periode = "Uke \n 47")

border_dt_48 <- calculate_border_index(
  border_dt_2019_48, 
  border_dt_2020_48) %>% 
  mutate(periode = "Uke \n 48")

border_dt_49 <- calculate_border_index(
  border_dt_2019_49, 
  border_dt_2020_49) %>% 
  mutate(periode = "Uke \n 49")

border_dt_50 <- calculate_border_index(
  border_dt_2019_50, 
  border_dt_2020_50) %>% 
  mutate(periode = "Uke \n 50")

border_dt_51 <- calculate_border_index(
  border_dt_2019_51, 
  border_dt_2020_51) %>% 
  mutate(periode = "Uke \n 51")


# ADD NEW WEEK HERE!
border_base_2019 <- bind_rows(border_dt_40,
                              border_dt_41,
                              border_dt_42,
                              border_dt_43,
                              border_dt_44,
                              border_dt_45,
                              border_dt_46,
                              border_dt_47,
                              border_dt_48,
                              border_dt_49,
                              border_dt_50,
                              border_dt_51
)


# Function for generating table
make_border_table <- function(border_base, caption_text) {
  
  border_base_table_ready <- border_base %>%
    dplyr::ungroup() %>% 
    dplyr::select(-no_trp) %>%
    dplyr::mutate(index = dplyr::na_if(index, "Inf")) %>% 
    tidyr::pivot_wider(names_from = ukedag,
                       values_from = index) %>% 
    dplyr::mutate(periode = stringr::str_replace(periode, " \n", ""))
  
  border_table <- border_base_table_ready %>% 
    flextable() %>%
    set_header_labels(periode = "Sammenlignet") %>%
    bold(part = "header") %>%
    bg(bg = "#ED9300", part = "header") %>%
    border_remove() %>%
    hline_top(part = "header", border = borderline) %>%
    hline_bottom(part = "all", border = borderline) %>%
    colformat_double(digits = 1) %>% 
    autofit() %>%
    height_all(height = .2) %>%
    set_caption(caption_text,
              autonum = table_numbers,
              style = "Tabelltekst")
  
  return(border_table)
}


make_border_trp_table <- function(border_trp_dt, caption_text) {
  
  border_trp_dt_table_ready <- border_trp_dt %>%
    select(-road, -adt, -municipality_name)
  
  border_trp_table <- border_trp_dt_table_ready %>% 
    flextable() %>%
    set_header_labels(name = "Punktnavn") %>%
    bold(part = "header") %>%
    bg(bg = "#ED9300", part = "header") %>%
    border_remove() %>%
    hline_top(part = "header", border = borderline) %>%
    hline_bottom(part = "all", border = borderline) %>%
    colformat_double(digits = 1) %>% 
    autofit() %>%
    height_all(height = .2) %>%
    set_caption(caption_text,
              autonum = table_numbers,
              style = "Tabelltekst")
  
  return(border_trp_table)
}

make_daily_border_plot <- function(area_dt, subtitle_text) {
  
  area_dt %>%
  ggplot2::ggplot(aes(ukedag, index)) +
  geom_bar(aes(fill = index > 0), stat = "identity",
           color = "#000000",
           alpha = 0.6) +
  scale_fill_manual(guide = FALSE, breaks = c(FALSE, TRUE),
                    values = c("#ed1c2e", "#58b02c")) +
  geom_hline(yintercept = 0, color = "#000000") +
  facet_grid(periode ~., switch = "y") +
  scale_y_continuous(position = "right",
                     limits = c(-100, 100),
                     breaks = c(-80, 0, 80)) +
  xlab("") +
  ylab("Endring i trafikkmengde (%)\n") +
  ggtitle(label = "Daglig endring i trafikkmengde over riksgrensen",
          subtitle = subtitle_text) +
  theme(strip.text.y = element_text(angle = 180),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank()) +
  labs(caption = "Data: Statens vegvesen")
}
```

<br>

**Tabelliste**
```{r list_of_tables}
officer::block_toc(style = "Tabelltekst")
```

<br>

**Figurliste**
```{r list_of_figures}
officer::block_toc(style = "Figurtekst")
```

# Bakgrunn

Som følge av smitteverntiltak i forbindelse med spredningen av koronaviruset SARS-CoV-2, er det interessant å se hvordan trafikken endret seg. De første tiltakene ble annonsert av Regjeringen torsdag 12. mars 2020 (uke 11), og trådde i kraft fredag 13. mars. Grensen til Finland åpnet mandag 15. juni (uke 25). Senere grenseåpninger og -stenginger er ikke notert her, men skal kunne ses i tallene for det enkelte trafikkregistreringspunkt.

Statens vegvesen har i dag til sammen 30 trafikkregistreringspunkter ved de ulike riksgrenseovergangene fra Svinesund i sør til Storskog i nordøst. Trafikken er ikke registrert i selve grenseovergangen, men litt inn på norsk side. Det er ingen store kryss mellom registreringspunktene og riksgrensen, slik at de fleste kjøretøy som blir registrert antas normalt å krysse riksgrensen, selv om enkelte kjøretøy kan stoppe og eventuelt snu på norsk side.

Datagrunnlaget for beregningene hentes fra disse trafikkregistreringspunktene. Det vil gi et representativt utvalg for å kunne beregne trafikkutviklingen. Det gjøres en sammenligning av døgntrafikken, ukedag mot ukedag. Mandag sammenlignes med mandag osv.  

Trafikkutviklingen sammenlignes ved at døgntrafikken sammenlignes med tilsvarende døgntrafikk i samme uke i 2019.

Denne rapporten viser utviklingen fra uke 40 og framover. Trafikkutvikling for tidligere uker finnes i egen rapport for uke 10-26, og 27-39.


Alle data er hentet fra [www.vegvesen.no/trafikkdata/](https://www.vegvesen.no/trafikkdata/). Døgntrafikk med minst 99 % dekningsgrad er brukt til å beregne prosentvis endring mellom to dager.

Vi tar forbehold om feil i datagrunnlaget. Enkelte trafikkregistreringspunkter er tidvis utelatt på grunn av feil på utstyr eller at de ligger på veier som er påvirket av vegarbeid o.l. Datagrunnlaget inkluderer likevel mange nok punkter til å få fram en generell trend i trafikkutviklingen.

Været vil enkelte dager kunne påvirke trafikkmengden. For eksempel vil det ved dårlig føre, som ved stort snøfall eller underkjølt regn, bli redusert framkommelighet og dette fører til mindre trafikk enn normalt. Spesielt gjelder dette en del av grenseovergangene som ligger i fjellstrøk. Enkelte grenseoverganger er vinterstid periodevis stengt på grunn av værforholdene.


# Trafikkregistreringspunkt ved riksgrenseovergangene
Trafikkregistreringspunktene som ligger ved riksgrenseovergangene, er listet opp i tabellen nedenfor.

<br>

```{r trptable}
border_trp_adt %>%
  select(-trp_id, -lat, -lon) %>% 
  flextable() %>%
  set_header_labels(name = "Punktnavn",
                    road_reference = "Vegsystemreferanse",
                    adt = "ÅDT",
                    municipality_name = "Kommune") %>%
  bold(part = "header") %>%
  bg(bg = "#ED9300", part = "header") %>%
  border_remove() %>%
  hline_top(part = "header", border = borderline) %>%
  hline_bottom(part = "all", border = borderline) %>%
  colformat_int(j = 4) %>% 
  autofit() %>%
  height_all(height = .2) %>%
  set_caption("Trafikkregistreringspunkter ved riksgrenseovergangene.",
              autonum = table_numbers,
              style = "Tabelltekst")
```


# Samlet endring i trafikk over riksgrensen
Figurene nedenfor viser samlet endring i trafikk over riksgrensen for hver ukedag.

<br>

```{r plot_2019_1, fig.width=6, fig.height=6, fig.cap="Estimert endring i trafikk over riksgrensen, uke 40 - 45."}
border_base_2019 %>% 
  dplyr::filter(periode %in% c("Uke \n 40",
                               "Uke \n 41",
                               "Uke \n 42",
                               "Uke \n 43",
                               "Uke \n 44",
                               "Uke \n 45")) %>% 
  make_daily_border_plot("Fra 2019 til 2020")
```

`r officer::fpar("", officer::run_pagebreak())`
```{r plot_2019_2, fig.width=6, fig.height=4, fig.cap="Estimert endring i trafikk over riksgrensen, uke 46 - 49."}
border_base_2019 %>% 
  dplyr::filter(periode %in% c("Uke \n 46",
                               "Uke \n 47",
                               "Uke \n 48",
                               "Uke \n 49",
                               "Uke \n 50",
                               "Uke \n 51")) %>% 
  make_daily_border_plot("Fra 2019 til 2020")
```

<br>

```{r table_2019}
make_border_table(border_base_2019,
                  "Prosentvis endring i trafikkmengde fra 2019 til 2020.")
```

<br>

I tabellen over er endringen i trafikkmengden oppgitt i prosent, sammenlignet med uke tilsvarende uke i 2019 som utgangspunkt. Det vil si at trafikken har gått ned fra år 2019 til samme ukedag i 2020, når prosentverdien er negativ.

<br>


# Endring i trafikk ved de enkelte riksgrenseovergangene
De følgende tabellene viser daglig endring i trafikk ved hvert av trafikkregistreringspunktene.

<br>

```{r trptable_201940}
make_border_trp_table(border_trp_dt_40,
                      "Prosentvis endring i trafikkmengde fra uke 40 2019 til uke 40 2020.")
```

`r officer::fpar("", officer::run_pagebreak())`
```{r trptable_201941}
make_border_trp_table(border_trp_dt_41,
                      "Prosentvis endring i trafikkmengde fra uke 41 2019 til uke 41 2020.")
```

`r officer::fpar("", officer::run_pagebreak())`
```{r trptable_201942}
make_border_trp_table(border_trp_dt_42,
                      "Prosentvis endring i trafikkmengde fra uke 42 2019 til uke 42 2020.")
```

`r officer::fpar("", officer::run_pagebreak())`
```{r trptable_201943}
make_border_trp_table(border_trp_dt_43,
                      "Prosentvis endring i trafikkmengde fra uke 43 2019 til uke 43 2020.")
```

`r officer::fpar("", officer::run_pagebreak())`
```{r trptable_201944}
make_border_trp_table(border_trp_dt_44,
                      "Prosentvis endring i trafikkmengde fra uke 44 2019 til uke 44 2020.")
```

`r officer::fpar("", officer::run_pagebreak())`
```{r trptable_201945}
make_border_trp_table(border_trp_dt_45,
                      "Prosentvis endring i trafikkmengde fra uke 45 2019 til uke 45 2020.")
```

`r officer::fpar("", officer::run_pagebreak())`
```{r trptable_201946}
make_border_trp_table(border_trp_dt_46,
                      "Prosentvis endring i trafikkmengde fra uke 46 2019 til uke 46 2020.")
```

`r officer::fpar("", officer::run_pagebreak())`
```{r trptable_201947}
make_border_trp_table(border_trp_dt_47,
                      "Prosentvis endring i trafikkmengde fra uke 47 2019 til uke 47 2020.")
```

`r officer::fpar("", officer::run_pagebreak())`
```{r trptable_201948}
make_border_trp_table(border_trp_dt_48,
                      "Prosentvis endring i trafikkmengde fra uke 48 2019 til uke 48 2020.")
```

`r officer::fpar("", officer::run_pagebreak())`
```{r trptable_201949}
make_border_trp_table(border_trp_dt_49,
                      "Prosentvis endring i trafikkmengde fra uke 49 2019 til uke 49 2020.")
```

```{r trptable_201950}
#make_border_trp_table(border_trp_dt_50,
#                      "Prosentvis endring i trafikkmengde fra uke 50 2019 til uke 50 2020.")
```

```{r trptable_201951}
#make_border_trp_table(border_trp_dt_51,
#                      "Prosentvis endring i trafikkmengde fra uke 51 2019 til uke 51 2020.")
```



