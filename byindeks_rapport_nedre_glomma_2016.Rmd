---
#title: Trafikkutvikling i byområder
output: 
  # html_document:
  #   toc: true
  #   fig_caption: true
  word_document:
    reference_docx: svv_notatmal3.docx
    toc: true
    toc_depth: 2
    fig_caption: true
    fig_width: 7
---

```{r setup, include = FALSE, echo = FALSE}
source("rmd_setup.R")
```

```{r points, include = FALSE}
road_lengths <- read_road_length_csv("road_lengths/glomma_road_lengths.csv")

all_point_info <- 
  read.csv2("data_indexpoints_tidy/indekspunkt_nedre-glomma_2016.csv")

city_info <-
    read.csv2("data_indexpoints_tidy/byindeks_nedre-glomma_2016.csv")

city_monthly <- 
  read.csv2("data_indexpoints_tidy/byindeks_maanedlig_kristiansand_2016.csv")

city_36_month <- 
  read.csv2("data_indexpoints_tidy/byindeks_36_maaneder_bergen_2016.csv")

# TODO: change to three year rolling when available
city_info_all_years <- city_info %>% 
  dplyr::filter(year == "2016-2020")

index_all_years <- round(city_info_all_years$index, digits = 1)
index_all_years_ci_lower <- 
  round(city_info_all_years$index - 
          city_info_all_years$konfidensintervall, digits = 1)
index_all_years_ci_upper <- 
  round(city_info_all_years$index + 
          city_info_all_years$konfidensintervall, digits = 1)
```

```{r child = 'formaal.Rmd'}
```


## Områdeavgrensing og vegnett
Dagens byindeks gjelder for kommunene Sarpsborg og Fredrikstad. Veglengder fordelt på vegkatori er vist i tabellene nedenfor.


```{r road_length}
road_lengths %>% create_municipality_road_length_table()
```



```{r road_length_sum}
road_lengths %>% create_city_road_length_table()
```

```{r child = 'vegnett.Rmd'}
```


## Byindekspunktene
Trafikkregistreringspunktene som inngår i byindeksen er listet opp i følgende tabell.

```{r point_table}
all_point_info %>%
  select(name, road_reference, adt, year) %>%
  flextable() %>%
  colformat_num(j = "adt",
                big.mark = " ", digits = 0) %>%
  set_header_labels(name = "Navn",
                    road_reference = "Vegreferanse",
                    adt = "ÅDT",
                    year = "År") %>%
  align(i = 1, j = 3, align = "center", part = "header") %>%
  bold(part = "header") %>%
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Lucida Sans Unicode", part = "all") %>%
  bg(bg = "#ED9300", part = "header") %>%
  border_remove() %>%
  hline_top(part = "header", border = borderline) %>%
  hline_bottom(part = "all", border = borderline) %>%
  autofit() %>%
  height_all(height = .2) %>%
  padding(padding.top = .3,
          padding.bottom = .3) %>%
  set_caption("Trafikkregistreringspunktene som inngår i byindeksen. ÅDT er oppgitt for lette biler (målt til kortere enn 5,6 m), og gjelder for det første året i avtaleperioden med god datakvalitet.")
```


Kartet nedenfor viser plasseringen av trafikkregistreringspunktene som benyttes i byindeksen.

```{r map_trp}
create_point_adt_map(all_point_info)
```

# Endring i trafikkmengde

Nullvekstmålet skal måles ved at trafikkutviklingen vurderes på et treårs glidende snitt, jf. brev fra Samferdselsdepartementet til de fire største byområdene datert 11.12.2019. Måloppnåelsen gjelder fremdeles avtaleperioden sett under ett. Det skal være netto nullvekst i perioden.

Endring i trafikkmengde er beregnet for hver måned mellom to påfølgende år, med januar i året etter referanseåret som første månedsindeks. Glidende tre års indeks bruker de siste 36 månedsindeks som grunnlag.


## Endring i glidende treårsperiode

Først når månedsindeks er beregnet gjennom tre år eller lenger, kan det beregnes en glidende treårsindeks. Den vil så oppdateres månedlig. Den første treårsindeksen inkluderer derfor månedsindeksene fra og med januar 2017 til og med desember 2019.

```{r city_table_36}
create_city_36_index_table(city_36_month)
# TODO: CI
```


## Endring per år
Endring i trafikkmengde er også beregnet for hele kalenderår. Tabellen nedenfor viser byindeksen for hvert år, samt for hele perioden.

```{r city_table}
create_city_index_table(city_info)
```

\newline
**Byindeksen estimerer endringen i trafikkmengden fra 
2016 til april 2020
til å være 
`r stringr::str_replace(as.character(index_all_years), "\\.", ",")` %.**
Usikkerheten knyttet til byindeksen gjenspeiles i et 95 % konfidensintervall som er fra
`r stringr::str_replace(as.character(index_all_years_ci_lower), "\\.", ",")` % til
`r stringr::str_replace(as.character(index_all_years_ci_upper), "\\.", ",")` %.




```{r all_point_info_long}
# all_point_info_long <- all_point_info %>% 
#   tidyr::gather(starts_with("index"), key = "period", value = "index_value") %>% 
#   dplyr::mutate(year = case_when(period == "index" ~ "2016-2019",
#                                    period == "index_16_17" ~ "2016-2017",
#                                    period == "index_17_18" ~ "2017-2018",
#                                    period == "index_18_19" ~ "2018-2019"),
#                 year = factor(year, levels = c("2016-2019",
#                                                    "2018-2019",
#                                                    "2017-2018",
#                                                    "2016-2017"),
#                                 ordered = TRUE))

all_point_info_long <- all_point_info %>% 
  dplyr::select(name, road_category_and_number, starts_with("index")) %>% 
  tidyr::pivot_longer(starts_with("index"), 
                      names_to = "period", 
                      values_to = "index_value") %>% 
  dplyr::mutate(year = case_when(period == "index" ~ "2016-2020",
                                 period == "index_17" ~ "2016-2017",
                                 period == "index_18" ~ "2017-2018",
                                 period == "index_19" ~ "2018-2019",
                                 period == "index_20" ~ "2019-2020"),
                year = factor(year, levels = c("2016-2020",
                                               "2019-2020",
                                               "2018-2019",
                                               "2017-2018",
                                               "2016-2017"
                                               ),
                                ordered = TRUE))
```

Nedenfor vises en graf over byindeksene for hver periode, sammen med alle punktindeksene.
\newline

```{r plot_city_index}
set.seed(123) # To keep the jittering the same for each render of the plot

city_info_each_one_year_and_total <- city_info 

ggplot() +
  geom_jitter(data = all_point_info_long,
              aes(year, index_value),
              color = "#ED9300", size = 2, alpha = 0.3, width = 0.1) +
  geom_hline(yintercept = 0, alpha = 0.3) +
  geom_segment(data = city_info_each_one_year_and_total,
               aes(x = year, xend = year,
                   y = 0, yend = index),
               color = "#ED9300", size = 0.6, alpha = 0.9) +
  geom_point(data = city_info_each_one_year_and_total,
             aes(year, index),
             color = "#ED9300", size = 5, alpha = 0.9) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Endring i trafikkmengde (%)",
       caption = "Data: Statens vegvesen") +
  ggtitle("Estimert endring i trafikkmengde i Grenland",
          subtitle = "Byindeksen (store prikker) og punktene (små prikker)")

```

Kartet nedenfor viser endringen i byindekspunktene fra referanseåret 2016 til 2019.

```{r map_trp_index}
create_pointindex_map(all_point_info)
```


Tabellen nedenfor gjengir byindekspunktene og deres indeksverdi. ÅDT er fra referanseår eller det året som er nærmest og som har en gyldig ÅDT-verdi.

\newline

```{r point_index_table}
index_column_names <- all_point_info %>% 
  select(starts_with("index")) %>% 
  names()

# all_point_info %>% 
#   select(name, road_reference, adt, 
#          starts_with("index")) %>% 
#   arrange(road_reference) %>% 
#   flextable() %>% 
#   colformat_num(j = "adt", 
#                 big.mark = " ", digits = 0) %>%
#   colformat_num(j = index_column_names, 
#                 digits = 1) %>%
#   set_header_labels(name = "Navn",
#                     road_reference = "Vegreferanse",
#                     adt = "ÅDT",
#                     index_16_17 = "Endring i trafikkmengde (%)") %>% 
#   add_header_row(values = c("", "", "2016", 
#                             "2016", "2017", "2018",
#                             "2016"), top = F) %>% 
#   add_header_row(values = c("", "", "", 
#                             "-2017", "-2018", "-2019",
#                             "-2019"), top = F) %>% 
#   merge_at(i = 1, j = 4:7, part = "header") %>% 
#   align(i = 1, j = 4, align = "right", part = "header") %>% 
#   align(i = 2, j = 3:7, align = "right", part = "header") %>% 
#   align(i = 3, j = 3:7, align = "right", part = "header") %>% 
#   bold(part = "header") %>% 
#   fontsize(size = 9, part = "all") %>% 
#   font(fontname = "Lucida Sans Unicode", part = "all") %>% 
#   bg(bg = "#ED9300", part = "header") %>% 
#   border_remove() %>% 
#   hline_top(part = "header", border = borderline) %>% 
#   hline_bottom(part = "all", border = borderline) %>% 
#   autofit() %>% 
#   height_all(height = .2) %>% 
#   padding(padding.top = .3,
#           padding.bottom = .3) %>% 
#   width(j = 4, width = 1) %>% 
#   set_caption("Estimert endring i trafikkmengde ved trafikkregistreringspunktene.")

all_point_info %>%
  select(name, road_category_and_number, starts_with("index")) %>%
  flextable() %>%
  colformat_num(j = index_column_names,
                digits = 1) %>%
  set_header_labels(name = "Navn",
                    road_category_and_number = "Veg",
                    index_17 = "Endring i trafikkmengde (%)") %>%
  add_header_row(values = c("", "",
                            "2016", "2017", "2018",
                            "2019", "2016"), top = F) %>%
  add_header_row(values = c("", "",
                            "-2017", "-2018", "-2019",
                            "-2020", "-2020"), top = F) %>%
  merge_at(i = 1, j = 3:7, part = "header") %>%
  align(i = 1, j = 3, align = "center", part = "header") %>%
  align(i = 2, j = 3:7, align = "right", part = "header") %>%
  align(i = 3, j = 3:7, align = "right", part = "header") %>%
  bold(part = "header") %>%
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Lucida Sans Unicode", part = "all") %>%
  bg(bg = "#ED9300", part = "header") %>%
  border_remove() %>%
  hline_top(part = "header", border = borderline) %>%
  hline_bottom(part = "all", border = borderline) %>%
  autofit() %>%
  height_all(height = .2) %>%
  padding(padding.top = .3,
          padding.bottom = .3) %>%
  width(j = 5, width = 1) %>%
  set_caption("Estimert endring i trafikkmengde ved trafikkregistreringspunktene.")
```
\newline

Punktet på Simo var på gamle Rv110 med to kjørefelt. Dette er ved slutten av 2019 erstattet av et nytt punkt på ny Rv110 med fire kjørefelt, men dette er ikke tatt med i indeksen ennå.

I figuren nedenfor er spredningen i punktindeksene illustrert. Den horisontale grønne streken viser byindeksens samlede verdi for perioden 2016 - april 2020.

\newline

```{r point_graph}
all_point_info_index <- all_point_info %>% 
  dplyr::filter(!is.na(index)) 

ggplot2::ggplot() +
  geom_point(data = all_point_info_index, 
             aes(x = reorder(name, index), y = index, size = adt),
             color = "#ED9300", alpha = 0.6) +
  geom_hline(yintercept = index_all_years, color = "#58B02C") +
  xlab("") +
  ylab("Endring i trafikkmengde (%)") +
  ggtitle(label = "ÅDT og endring i trafikkmengde",
          subtitle = "Fra 2016 til april 2020") +
  coord_flip() +
  scale_size(name = "ÅDT") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, 
                ymin = index_all_years_ci_lower, 
                ymax = index_all_years_ci_upper),
            alpha = 0.1, fill = "#008EC2") +
  theme_minimal() +
  theme(legend.position = "right",
        axis.text.y = element_text(size = 7)) +
  labs(caption = "Data: Statens vegvesen")
```

## Endring per måned

Tabellen viser endring i trafikk per måned, sammenlignet med samme måned året før.

```{r monthly_city_index}
create_monthly_city_index_table(city_monthly)
```