---
title: Daglig endring i trafikk i de største byområdene
output: 
  word_document:
    reference_docx: svv_notatmal3.docx
    toc: true
    toc_depth: 2
    fig_caption: true
    fig_width: 7
---

```{r setup, include = FALSE, echo = FALSE, warning=FALSE, message=FALSE}
# Packages are loaded through sourcing rmd_setup.R
source("rmd_setup.R")

# Traffic Data API calls to get points metadata and aadt
source("get_from_trafficdata_api.R")

# Points used in each city
cities_points_start <- read.csv2("data_points_raw/cities_points.csv") %>% 
  dplyr::filter(city_area_name %in% c("Bergen",
                                      "Nord-Jæren",
                                      "Oslo og Akershus",
                                      "Trondheim",
                                      "Tromsø"),
                !is.na(trp_id)) %>% 
  dplyr::distinct(trp_id, .keep_all = TRUE) %>% 
  dplyr::select(city_area_name, trp_id) %>% 
  # Remove unusable trps
  dplyr::filter(!(trp_id %in% c("65625V41945",
                                "21801V72158",
                                "81008V41567",
                                "14772V41375",
                                "20570V72811",
                                "17949V320695",
                                "75341V41863",
                                "84064V320581")))

additional_trps <- 
  data.frame(city_area_name = 
               c(rep("Trondheim", times = 9),
                 rep("Nord-Jæren", times = 28),
                 rep("Bodø", times = 11)),
             trp_id = c(
                                  # Trondheim
                                  "04211V1677432",
                                  "78492V2394249",
                                  "44660V72811",
                                  "75341V41863",
                                  "17961V72812",
                                  "36935V72359",
                                  "01676V41944",
                                  "60797V2801059",
                                  "66126V3112188",
                                  # Nord-Jæren
                                  #"93189V320582",
                                  "52780V320689",
                                  "13715V2721330",
                                  "14570V320273",
                                  #"50749V319525",
                                  "11531V320190",
                                  #"71535V319524",
                                  "50741V1727509",
                                  "41451V320581",
                                  "64211V2520554",
                                  "55507V319881",
                                  "33926V2721315",
                                  "12478V320582",
                                  "88125V320152",
                                  "33902V320184",
                                  "08952V320223",
                                  "81631V1727485",
                                  "59675V319722",
                                  "58562V320296",
                                  "03819V320689",
                                  "45342V320223",
                                  "44083V319868",
                                  "35382V1727514",
                                  "24330V320678",
                                  "36178V320198",
                                  #"92102V319885",
                                  #"32842V319521",
                                  "61487V319872",
                                  "00462V320124",
                                  "48362V320684",
                                  "89794V320138",
                                  "05658V320707",
                                  "57836V319878",
                                  # Bodø
                                  "18346V886007",
                                  "43264V886007",
                                  "66316V2676855",
                                  "33696V2676853",
                                  "91229V886007",
                                  "26549V2669516",
                                  "29133V1201961",
                                  "90646V1201961",
                                  "74801V2676825",
                                  "77027V1207593",
                                  "86957V885288"
                                  ))

cities_points <- bind_rows(cities_points_start, additional_trps)

# All points from Traffic Data API
points <- get_points() %>%
  dplyr::select(trp_id, name, road_reference, municipality_name,
                lat, lon) %>%
  dplyr::distinct(trp_id, .keep_all = T)

# Adding metadata to trps
trps <- dplyr::left_join(cities_points, points) %>%
  dplyr::filter(!is.na(name)) %>% 
  dplyr::filter(!stringr::str_detect(road_reference, "KD"))

# Fetch daily traffic
week_2019_from <- "2019-09-30T00:00:00+02:00"
week_2019_to <- "2019-10-28T00:00:00+02:00"

week_2020_from <- "2020-09-28T00:00:00+02:00"
week_2020_to <- "2020-10-26T00:00:00+02:00"

ukedager <- c("Mandag",
              "Tirsdag",
              "Onsdag",
              "Torsdag",
              "Fredag",
              "Lørdag",
              "Søndag")

norske_ukedager <- data.frame(weekday = c(1, 2, 3, 4, 5, 6, 7),
                              ukedag = ordered(ukedager,
                                               levels = ukedager))

# Fetch daily traffic from API
dt_2019 <- get_dt_for_trp_list(trps$trp_id,
                               week_2019_from,
                               week_2019_to)

dt_2020 <- get_dt_for_trp_list(trps$trp_id,
                               week_2020_from,
                               week_2020_to)

dt <- bind_rows(dt_2019, dt_2020) %>%
  select(-point_name) %>%
  mutate(year = lubridate::year(from),
         weekno = lubridate::isoweek(from),
         weekday = lubridate::wday(from,
                                   week_start = 
                                     getOption("lubridate.week.start", 1))) %>%
  select(-from) %>% 
  filter(coverage > 99)


# Weeks 2019 ####
dt_2019_40 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 40) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244"
    )))

dt_2019_41 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 41) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244"
    )))

dt_2019_42 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 42) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244",
                           "09105V320634"
    )))

dt_2019_43 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 43) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244",
                           "09105V320634"
    )))

dt_2019_44 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 44) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244",
                           "09105V320634"
    )))

dt_2019_45 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 45) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244",
                           "09105V320634"
    )))

dt_2019_46 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 46) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244",
                           "09105V320634"
    )))

dt_2019_47 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 47) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244",
                           "09105V320634"
    )))

dt_2019_48 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 48) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244",
                           "09105V320634"
    )))

dt_2019_49 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 49) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244",
                           "09105V320634"
    )))

dt_2019_50 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 50) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244",
                           "09105V320634"
    )))

dt_2019_51 <- dt %>% 
  filter(year == 2019) %>%
  filter(weekno == 51) %>%
  select(point_id, total_volume, weekno, weekday) %>% 
  filter(!(point_id %in% c("42754V444240",
                           "33808V625649",
                           "18573V444291",
                           "81350V444302",
                           "44660V72811",
                           "75341V41863",
                           "57279V320244",
                           "09105V320634"
    )))

# ADD NEW WEEK HERE!


# Weeks 2020 ####
dt_2020_40 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 40) %>% 
  select(point_id, total_volume, weekno, weekday) 

dt_2020_41 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 41) %>% 
  select(point_id, total_volume, weekno, weekday) 

dt_2020_42 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 42) %>% 
  select(point_id, total_volume, weekno, weekday) 

dt_2020_43 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 43) %>% 
  select(point_id, total_volume, weekno, weekday) 

dt_2020_44 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 44) %>% 
  select(point_id, total_volume, weekno, weekday) 

dt_2020_45 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 45) %>% 
  select(point_id, total_volume, weekno, weekday) 

dt_2020_46 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 46) %>% 
  select(point_id, total_volume, weekno, weekday) 

dt_2020_47 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 47) %>% 
  select(point_id, total_volume, weekno, weekday) 

dt_2020_48 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 48) %>% 
  select(point_id, total_volume, weekno, weekday) 

dt_2020_49 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 49) %>% 
  select(point_id, total_volume, weekno, weekday) 

dt_2020_50 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 50) %>% 
  select(point_id, total_volume, weekno, weekday) 

dt_2020_51 <- dt %>% 
  filter(year == 2020) %>%
  filter(weekno == 51) %>% 
  select(point_id, total_volume, weekno, weekday) 


# ADD NEW WEEK HERE!


# Trp index
calculate_trp_index <- function(dt_base, dt_calc) {
  trp_daily_index <- inner_join(dt_base, dt_calc,
                            by = c("point_id", "weekday"),
                            suffix = c("_b", "_c")) %>% 
  mutate(index = round((total_volume_c / total_volume_b - 1) * 100, digits = 1)) %>% 
  left_join(norske_ukedager) %>% 
  select(point_id, ukedag, index) %>% 
  left_join(points, by = c("point_id" = "trp_id")) %>% 
  left_join(cities_points, by = c("point_id" = "trp_id")) %>% 
  select(ukedag, name, road_reference, city_area_name, index) %>% 
  tidyr::pivot_wider(names_from = ukedag,
                       values_from = index) %>% 
  arrange(city_area_name, road_reference)
}

# Compare week 2020 to same week 2019 ####
trp_dt_40 <- calculate_trp_index(dt_2019_40, dt_2020_40) 
trp_dt_41 <- calculate_trp_index(dt_2019_41, dt_2020_41)
trp_dt_42 <- calculate_trp_index(dt_2019_42, dt_2020_42)
trp_dt_43 <- calculate_trp_index(dt_2019_43, dt_2020_43)
trp_dt_44 <- calculate_trp_index(dt_2019_44, dt_2020_44)
trp_dt_45 <- calculate_trp_index(dt_2019_45, dt_2020_45)
trp_dt_46 <- calculate_trp_index(dt_2019_46, dt_2020_46)
trp_dt_47 <- calculate_trp_index(dt_2019_47, dt_2020_47)
trp_dt_48 <- calculate_trp_index(dt_2019_48, dt_2020_48)
trp_dt_49 <- calculate_trp_index(dt_2019_49, dt_2020_49)
trp_dt_50 <- calculate_trp_index(dt_2019_50, dt_2020_50)
trp_dt_51 <- calculate_trp_index(dt_2019_51, dt_2020_51)


# City index ####
calculate_city_index <- function(dt_base, dt_calc) {
  city_daily_index <- inner_join(dt_base, dt_calc,
                            by = c("point_id", "weekday"),
                            suffix = c("_b", "_c")) %>% 
  left_join(cities_points, by = c("point_id" = "trp_id")) %>% 
  group_by(weekday, city_area_name) %>% 
  summarise(city_volume_b = sum(total_volume_b),
            city_volume_c = sum(total_volume_c),
            no_trp = n()
            ) %>% 
  mutate(index = round((city_volume_c / city_volume_b - 1) * 100, 
                       digits = 1)) %>% 
  left_join(norske_ukedager) %>% 
  select(city_area_name, ukedag, no_trp, index)
}



# Compare this week to same week 2019
city_dt_40 <- calculate_city_index(dt_2019_40, dt_2020_40) %>% 
  #filter(!(city_area_name %in% c("Bodø"))) %>% 
  mutate(weekno = "40")

city_dt_41 <- calculate_city_index(dt_2019_41, dt_2020_41) %>% 
  mutate(weekno = "41")

city_dt_42 <- calculate_city_index(dt_2019_42, dt_2020_42) %>% 
  mutate(weekno = "42")

city_dt_43 <- calculate_city_index(dt_2019_43, dt_2020_43) %>% 
  mutate(weekno = "43")

city_dt_44 <- calculate_city_index(dt_2019_44, dt_2020_44) %>%
  mutate(weekno = "44")

city_dt_45 <- calculate_city_index(dt_2019_45, dt_2020_45) %>% 
  mutate(weekno = "45")

city_dt_46 <- calculate_city_index(dt_2019_46, dt_2020_46) %>% 
  mutate(weekno = "46")

city_dt_47 <- calculate_city_index(dt_2019_47, dt_2020_47) %>% 
  mutate(weekno = "47")

city_dt_48 <- calculate_city_index(dt_2019_48, dt_2020_48) %>% 
  mutate(weekno = "48")

city_dt_49 <- calculate_city_index(dt_2019_49, dt_2020_49) %>% 
  mutate(weekno = "49")

city_dt_50 <- calculate_city_index(dt_2019_50, dt_2020_50) %>% 
  mutate(weekno = "50")

city_dt_51 <- calculate_city_index(dt_2019_51, dt_2020_51) %>% 
  mutate(weekno = "51")


# Cities week by week
city_dt_2019_2020_weeks = bind_rows(city_dt_40,
                                    city_dt_41,
                                    city_dt_42,
                                    city_dt_43,
                                    city_dt_44,
                                    city_dt_45,
                                    city_dt_46,
                                    city_dt_47,
                                    city_dt_48,
                                    city_dt_49,
                                    city_dt_50,
                                    city_dt_51
                                   )

oslo_og_akershus_dt_2019_2020 <- city_dt_2019_2020_weeks %>% 
  filter(city_area_name == "Oslo og Akershus") %>% 
  select(weekday, ukedag, no_trp, index, weekno)

bergen_dt_2019_2020 <- city_dt_2019_2020_weeks %>% 
  filter(city_area_name == "Bergen") %>% 
  select(weekday, ukedag, no_trp, index, weekno)

bodo_dt_2019_2020 <- city_dt_2019_2020_weeks %>% 
  filter(city_area_name == "Bodø") %>% 
  select(weekday, ukedag, no_trp, index, weekno)

nord_jaeren_dt_2019_2020 <- city_dt_2019_2020_weeks %>% 
  filter(city_area_name == "Nord-Jæren") %>% 
  select(weekday, ukedag, no_trp, index, weekno)

trondheim_dt_2019_2020 <- city_dt_2019_2020_weeks %>% 
  filter(city_area_name == "Trondheim") %>% 
  select(weekday, ukedag, no_trp, index, weekno)

tromsoe_dt_2019_2020 <- city_dt_2019_2020_weeks %>% 
  filter(city_area_name == "Tromsø") %>% 
  select(weekday, ukedag, no_trp, index, weekno)


# Function for generating table ####
make_city_table <- function(city_dt, caption_text) {
  
  city_dt_table_ready <- city_dt %>%
    dplyr::ungroup() %>% 
    dplyr::select(-weekday, -no_trp) %>%
    dplyr::mutate(index = dplyr::na_if(index, "Inf")) %>% 
    tidyr::pivot_wider(names_from = ukedag,
                values_from = index)
  
  ncol_dt <- ncol(city_dt_table_ready)
  
  city_table <- city_dt_table_ready %>% 
    flextable() %>%
    set_header_labels(city_area_name = "Byområde") %>%
    bold(part = "header") %>%
    fontsize(size = 9, part = "all") %>%
    font(fontname = "Lucida Sans Unicode", part = "all") %>%
    bg(bg = "#ED9300", part = "header") %>%
    border_remove() %>%
    hline_top(part = "header", border = borderline) %>%
    hline_bottom(part = "all", border = borderline) %>%
    colformat_num(j = 2:ncol_dt, na_str = "", digits = 1) %>% 
    autofit() %>%
    height_all(height = .2) %>%
    padding(padding.top = .3,
            padding.bottom = .3) %>%
    set_caption(caption_text)
  
  return(city_table)
}

make_city_table_city <- function(city_dt, caption_text) {
  
  city_dt_table_ready <- city_dt %>%
    dplyr::ungroup() %>% 
    dplyr::select(-weekday, -no_trp) %>%
    dplyr::mutate(index = dplyr::na_if(index, "Inf")) %>% 
    tidyr::pivot_wider(names_from = ukedag,
                values_from = index)
  
  ncol_dt <- ncol(city_dt_table_ready)
  
  city_table <- city_dt_table_ready %>% 
    flextable() %>%
    set_header_labels(weekno = "Uke") %>%
    bold(part = "header") %>%
    fontsize(size = 9, part = "all") %>%
    font(fontname = "Lucida Sans Unicode", part = "all") %>%
    bg(bg = "#ED9300", part = "header") %>%
    border_remove() %>%
    hline_top(part = "header", border = borderline) %>%
    hline_bottom(part = "all", border = borderline) %>%
    colformat_num(j = 2:ncol_dt, na_str = "", digits = 1) %>% 
    autofit() %>%
    height_all(height = .2) %>%
    padding(padding.top = .3,
            padding.bottom = .3) %>%
    set_caption(caption_text)
  
  return(city_table)
}

make_daily_plot_city <- function(area_dt, subtitle_text) {
  
  area_dt %>%
  ggplot2::ggplot(aes(ukedag, index)) +
  geom_bar(aes(fill = index > 0), stat = "identity",
           color = "#000000", 
           alpha = 0.6) +
  scale_fill_manual(guide = FALSE, breaks = c(FALSE, TRUE), 
                    values = c("#ed1c2e", "#58b02c")) +
  geom_hline(yintercept = 0, color = "#000000") +
  facet_grid(weekno ~., switch = "y") +
  scale_y_continuous(position = "right",
                     limits = c(-20, 20),
                     breaks = c(-10, 0, 10)) +
  xlab("") +
  ylab("Endring i trafikkmengde (%)\n") +
  ggtitle(label = "Daglig endring i trafikkmengde",
          subtitle = subtitle_text) +
  theme(strip.text.y = element_text(angle = 180),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank()) +
  labs(caption = "Data: Statens vegvesen")
}
```


# Bakgrunn

Som følge av smitteverntiltak i forbindelse med spredningen av det nye koronaviruset SARS-CoV-2, er det interessant å se hvordan trafikken endret seg. De første tiltakene ble annonsert av Regjeringen torsdag 12. mars 2020 (uke 11), og trådde i kraft fredag 13. mars.

Datagrunnlaget for beregningene hentes fra trafikkregistreringspunktene som inngår i byindeksene. Det vil gi et representativ utvalg for å kunne beregne trafikkutviklingen. Det gjøres en sammenligning av døgntrafikken, ukedag mot ukedag. Mandag sammenlignes med mandag osv.  

For å få et best mulig bilde av trafikkutviklingen sammenligninges her døgntrafikken sammenlignes med tilsvarende døgntrafikk i samme uke i 2019.

Denne rapporten viser tall fra og med uke 40. Trafikkutvikling for tidligere uker finnes i egen rapport for uke 10-26 og uke 27-39.

Alle data er hentet fra [trafikkdata.no](https://www.trafikkdata.no/). Døgntrafikk med minst 99 % dekningsgrad er brukt til å beregne prosentvis endring mellom to dager.

Vi tar forbehold om feil i datagrunnlaget. Enkelte trafikkregistreringspunkter er utelatt på grunn av feil på utstyr eller at de ligger på veier som er påvirket av vegarbeid o.l. Datagrunnlaget inkluderer likevel mange nok punkter til å få fram en generell trend i trafikkutviklingen.

Været vil enkelte dager kunne påvirke trafikkmengden. For eksempel vil det ved dårlig føre, som ved stort snøfall eller underkjølt regn, bli redusert framkommelighet og dette fører til mindre trafikk enn normalt.



# Endring i trafikk fra 2019 til 2020


## Bergen
```{r table_city_bergen}
make_city_table_city(bergen_dt_2019_2020,
                "Prosentvis endring i trafikkmengde i Bergen 2019 til 2020.")
```
\
```{r plot_city_bergen, fig.width=8, fig.height=8}
make_daily_plot_city(bergen_dt_2019_2020, "")
```

## Bodø
```{r table_city_bodo}
make_city_table_city(bodo_dt_2019_2020,
                "Prosentvis endring i trafikkmengde i Bodø 2019 til 2020.")
```
\
```{r plot_city_bodo, fig.width=8, fig.height=8}
make_daily_plot_city(bodo_dt_2019_2020, "")
```

## Nord-Jæren
```{r table_city_nord-jaeren}
make_city_table_city(nord_jaeren_dt_2019_2020,
                "Prosentvis endring i trafikkmengde i Nord-Jæren 2019 til 2020.")
```
\
```{r plot_city_nord_jaeren, fig.width=8, fig.height=8}
make_daily_plot_city(nord_jaeren_dt_2019_2020, "")
```

## Oslo og Akershus
```{r table_city_oslo_akershus}
make_city_table_city(oslo_og_akershus_dt_2019_2020,
                "Prosentvis endring i trafikkmengde i Oslo og Akershus 2019 til 2020.")
```
\
```{r plot_city_oslo_og_akershus, fig.width=8, fig.height=8}
make_daily_plot_city(oslo_og_akershus_dt_2019_2020, "")
```

## Tromsø
```{r table_city_tromsoe}
make_city_table_city(tromsoe_dt_2019_2020,
                "Prosentvis endring i trafikkmengde i Tromsø 2019 til 2020.")
```
\
```{r plot_city_tromsoe, fig.width=8, fig.height=8}
make_daily_plot_city(tromsoe_dt_2019_2020, "")
```

## Trondheim
```{r table_city_trondheim}
make_city_table_city(trondheim_dt_2019_2020,
                "Prosentvis endring i trafikkmengde i Trondheim 2019 til 2020.")
```
\
```{r plot_city_trondheim, fig.width=8, fig.height=8}
make_daily_plot_city(trondheim_dt_2019_2020, "")
```





